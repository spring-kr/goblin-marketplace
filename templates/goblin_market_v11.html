<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ† ë„ê¹¨ë¹„ë§ˆì„ì¥í„° v11.5 - ì™„ì „ì²´ AI ìƒë‹´ ì‹œìŠ¤í…œ</title>
    
    <!-- Vercel Analytics - ë°©ë¬¸ì ë° í˜ì´ì§€ ì¡°íšŒìˆ˜ ì¶”ì  -->
    <script defer src="https://analytics.eu.vercel-insights.com/script.js"></script>
    
    <!-- Socket.IO -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    
    <!-- CSS ìŠ¤íƒ€ì¼ -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .header {
            background: rgba(255,255,255,0.95);
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left h1 {
            color: #5a67d8;
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .header-left .subtitle {
            color: #666;
            font-size: 1rem;
        }

        .header-right {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .dashboard-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            text-decoration: none;
            font-weight: bold;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dashboard-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            text-decoration: none;
        }

        .main-container {
            display: grid;
            grid-template-columns: 300px 1fr 500px;
            gap: 1rem;
            padding: 1rem;
            max-width: 1800px;
            margin: 0 auto;
            height: calc(100vh - 120px);
        }

        /* ì˜¤ë¥¸ìª½ ì•„ë°”íƒ€ ëŒ€ì‹œë³´ë“œ */
        .avatar-dashboard {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .avatar-dashboard h3 {
            color: #5a67d8;
            margin-bottom: 1rem;
            font-size: 1.2rem;
            text-align: center;
        }

        #avatar-container {
            width: 100%;
            height: 900px;
            background: linear-gradient(135deg, #2c3e50, #34495e);
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            position: relative;
        }

        .avatar-info {
            background: rgba(90, 103, 216, 0.1);
            border-radius: 10px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .avatar-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .stat-item {
            background: rgba(255,255,255,0.8);
            padding: 0.5rem;
            border-radius: 5px;
            text-align: center;
            font-size: 0.85rem;
        }

        .emotion-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .emotion-btn {
            padding: 0.4rem 0.8rem;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 80px;
        }

        .emotion-btn.happy { background: #e8f5e8; color: #27ae60; }
        .emotion-btn.sad { background: #f8e8e8; color: #e74c3c; }
        .emotion-btn.excited { background: #fff3e0; color: #f39c12; }
        .emotion-btn.neutral { background: #f8f9fa; color: #6c757d; }
        .emotion-btn.thinking { background: #e3f2fd; color: #2196f3; }

        .emotion-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .memory-display {
            background: rgba(155, 89, 182, 0.1);
            border-radius: 8px;
            padding: 0.8rem;
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        .avatar-chat {
            background: rgba(52, 152, 219, 0.1);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .avatar-chat input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .avatar-chat button {
            width: 100%;
            padding: 0.5rem;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        /* ì±„íŒ… ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        .message {
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            border-radius: 8px;
            word-wrap: break-word;
            white-space: pre-wrap;
            line-height: 1.4;
            font-size: 0.85rem;
        }

        .user-message {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            text-align: right;
            margin-left: 20%;
        }

        .avatar-message {
            background: #f3e5f5;
            border: 1px solid #e1bee7;
            text-align: left;
            margin-right: 20%;
        }

        .avatar-chat button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        /* ë„ê¹¨ë¹„ íŒ¨ë„ */
        .goblin-panel {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            overflow-y: auto;
        }

        .goblin-panel h3 {
            color: #5a67d8;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .goblin-card {
            background: #f8f9ff;
            border: 2px solid transparent;
            border-radius: 10px;
            padding: 0.8rem;
            margin-bottom: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .goblin-card:hover {
            border-color: #5a67d8;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(90,103,216,0.2);
        }

        .goblin-card.selected {
            border-color: #5a67d8;
            background: #eef2ff;
        }

        .goblin-name {
            font-weight: bold;
            color: #5a67d8;
            margin-bottom: 0.3rem;
        }

        .goblin-specialty {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 0.3rem;
        }

        .goblin-personality {
            font-size: 0.8rem;
            color: #888;
            font-style: italic;
            margin-bottom: 0.3rem;
        }

        .goblin-price {
            font-size: 0.9rem;
            font-weight: bold;
            color: #e53e3e;
            background: rgba(229, 62, 62, 0.1);
            padding: 0.2rem 0.5rem;
            border-radius: 0.3rem;
            text-align: center;
        }

        .goblin-price:contains('ë¬´ë£Œ') {
            color: #38a169;
            background: rgba(56, 161, 105, 0.1);
        }

        /* ì±„íŒ… ì˜ì—­ */
        .chat-container {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .chat-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            background: #5a67d8;
            color: white;
            border-radius: 15px 15px 0 0;
        }

        .chat-mode-selector {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .mode-btn {
            padding: 0.3rem 0.8rem;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1);
            color: white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .mode-btn.active {
            background: rgba(255,255,255,0.9);
            color: #5a67d8;
        }

        .chat-messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            max-height: 400px;
        }

        .message {
            margin-bottom: 1rem;
            animation: fadeInUp 0.3s ease;
        }

        .message.user {
            text-align: right;
        }

        .message.goblin {
            text-align: left;
        }

        .message-bubble {
            display: inline-block;
            max-width: 80%;
            padding: 0.8rem 1.2rem;
            border-radius: 20px;
            line-height: 1.4;
        }

        .message.user .message-bubble {
            background: #5a67d8;
            color: white;
        }

        .message.goblin .message-bubble {
            background: #f1f5f9;
            color: #334155;
            border: 1px solid #e2e8f0;
        }

        .message-time {
            font-size: 0.7rem;
            color: #888;
            margin-top: 0.3rem;
        }

        .chat-input-area {
            padding: 1rem 1.5rem;
            border-top: 1px solid #e2e8f0;
            background: #f8fafc;
            border-radius: 0 0 15px 15px;
        }

        .input-container {
            display: flex;
            gap: 0.5rem;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            padding: 0.8rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 25px;
            font-size: 1rem;
            resize: none;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .chat-input:focus {
            border-color: #5a67d8;
        }

        .send-btn {
            padding: 0.8rem 1.5rem;
            background: #5a67d8;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .send-btn:hover {
            background: #4c51bf;
            transform: translateY(-1px);
        }

        .send-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        /* ì„±ëŠ¥ íŒ¨ë„ */
        .performance-panel {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            overflow-y: auto;
        }

        .performance-panel h3 {
            color: #5a67d8;
            margin-bottom: 1rem;
        }

        .stat-card {
            background: #f8f9ff;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #5a67d8;
            margin-bottom: 0.3rem;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }

        .team-mode-section {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
        }

        .team-btn {
            width: 100%;
            padding: 0.8rem;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }

        .team-btn:hover {
            background: #059669;
            transform: translateY(-1px);
        }

        .feedback-section {
            margin-top: 1rem;
            padding: 1rem;
            background: #fff7ed;
            border-radius: 10px;
            border: 1px solid #fed7aa;
        }

        .rating-stars {
            display: flex;
            gap: 0.3rem;
            justify-content: center;
            margin: 0.5rem 0;
        }

        .star {
            font-size: 1.5rem;
            cursor: pointer;
            color: #d1d5db;
            transition: color 0.2s ease;
        }

        .star.active {
            color: #fbbf24;
        }

        .feedback-btn {
            width: 100%;
            padding: 0.5rem;
            background: #f59e0b;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 0.5rem;
            transition: all 0.3s ease;
        }

        .feedback-btn:hover {
            background: #d97706;
        }

        /* ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ */
        .loading {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .loading-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #f3f4f6;
            border-top: 2px solid #5a67d8;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ë°˜ì‘í˜• ë””ìì¸ */
        @media (max-width: 1024px) {
            .main-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr auto;
                height: auto;
            }
            
            .goblin-panel, .performance-panel {
                max-height: 200px;
            }
        }

        /* ì•Œë¦¼ í† ìŠ¤íŠ¸ */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.error {
            background: #ef4444;
        }
    </style>
</head>

<body>
    <!-- í—¤ë” -->
    <div class="header">
        <div class="header-left">
            <h1>ğŸ† ë„ê¹¨ë¹„ë§ˆì„ì¥í„° v11.5</h1>
            <p class="subtitle">32ëª… ì „ë¬¸ê°€ Ã— 27ëª… ë„ê¹¨ë¹„ Ã— ì‹¤ì‹œê°„ í•™ìŠµ = ì™„ì „ì²´ AI ìƒë‹´ ì‹œìŠ¤í…œ</p>
        </div>
        <div class="header-right">
            <a href="/dashboard" class="dashboard-btn">
                ğŸ® 3D ì‹¤ì‹œê°„ ëŒ€ì‹œë³´ë“œ
            </a>
        </div>
    </div>

    <!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
    <div class="main-container">
        <!-- ë„ê¹¨ë¹„ ì„ íƒ íŒ¨ë„ -->
        <div class="goblin-panel">
            <h3>ğŸ§™â€â™‚ï¸ ë„ê¹¨ë¹„ ì„ íƒ</h3>
            <div id="goblin-list">
                <!-- ë„ê¹¨ë¹„ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>
            
            <div class="team-mode-section">
                <h4>ğŸ¤ íŒ€ í˜‘ì—… ëª¨ë“œ</h4>
                <button class="team-btn" onclick="startTeamMode()">ì„ íƒëœ ë„ê¹¨ë¹„ë“¤ê³¼ í˜‘ì—…</button>
                <button class="team-btn" onclick="goToPayment()" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); margin-left: 10px;">ğŸ’³ ìœ ë£Œ ìƒë‹´ ì‹ ì²­</button>
                <div id="selected-goblins">
                    <small>ì„ íƒëœ ë„ê¹¨ë¹„: <span id="selected-count">0</span>ëª…</small>
                </div>
            </div>
        </div>

        <!-- ì±„íŒ… ì˜ì—­ -->
        <div class="chat-container">
            <div class="chat-header">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 id="chat-title">ë„ê¹¨ë¹„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</h3>
                    <button id="new-chat-btn" onclick="startNewChatSession()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 0.4rem 0.8rem; border-radius: 15px; cursor: pointer; font-size: 0.8rem; display: none;">
                        ğŸ”„ ìƒˆ ëŒ€í™”
                    </button>
                </div>
                <div class="chat-mode-selector">
                    <div class="mode-btn active" data-mode="deep">ì‹¬í™”íƒêµ¬</div>
                    <div class="mode-btn" data-mode="creative">ì°½ì˜í˜‘ì—…</div>
                </div>
            </div>
            
            <div class="chat-messages" id="chat-messages">
                <div class="message goblin">
                    <div class="message-bubble" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);">
                        <div style="text-align: center; padding: 1rem;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">ï¿½âœ¨</div>
                            <div style="font-size: 1.3rem; font-weight: bold; margin-bottom: 0.8rem; color: #fff;">
                                ë„ê¹¨ë¹„ë§ˆì„ì¥í„°ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!
                            </div>
                            <div style="background: rgba(255,255,255,0.2); padding: 1rem; border-radius: 12px; margin: 1rem 0;">
                                <div style="font-size: 1rem; line-height: 1.6; margin-bottom: 0.8rem;">
                                    ğŸ§™â€â™‚ï¸ <strong>32ëª…ì˜ ì „ë¬¸ê°€ ë„ê¹¨ë¹„</strong>ê°€ ì—¬ëŸ¬ë¶„ì„ ê¸°ë‹¤ë¦¬ê³  ìˆì–´ìš”!
                                </div>
                                <div style="font-size: 0.9rem; line-height: 1.5; opacity: 0.9;">
                                    ğŸ’¡ <strong>ì‹¬í™”íƒêµ¬</strong>ì™€ <strong>ì°½ì˜í˜‘ì—…</strong> ëª¨ë“œë¡œ<br>
                                    ë‹¤ì–‘í•œ ê´€ì ì˜ ì „ë¬¸ì ì¸ ì¡°ì–¸ì„ ë°›ì•„ë³´ì„¸ìš”
                                </div>
                            </div>
                            <div style="font-size: 0.85rem; opacity: 0.8; margin-top: 1rem;">
                                ğŸ‘ˆ ì¢Œì¸¡ì—ì„œ ë„ê¹¨ë¹„ë¥¼ ì„ íƒí•˜ê±°ë‚˜ íŒ€ í˜‘ì—… ëª¨ë“œë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”!
                            </div>
                        </div>
                    </div>
                    <div class="message-time" style="text-align: center; color: #667eea; font-weight: 500;">ğŸ° ë„ê¹¨ë¹„ë§ˆì„ì¥í„° v11.5</div>
                </div>
            </div>
            
            <div class="chat-input-area">
                <div class="input-container">
                    <textarea 
                        id="chat-input" 
                        class="chat-input" 
                        placeholder="ë„ê¹¨ë¹„ì—ê²Œ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." 
                        rows="2"
                        disabled
                    ></textarea>
                    <button id="send-btn" class="send-btn" onclick="sendMessage()" disabled>
                        ì „ì†¡
                    </button>
                </div>
            </div>
        </div>

        <!-- ì‹¤ì‹œê°„ ì•„ë°”íƒ€ ëŒ€ì‹œë³´ë“œ -->
        <div class="avatar-dashboard">
            <h3>ï¿½ ì‹¤ì‹œê°„ ì•„ë°”íƒ€ ëŒ€ì‹œë³´ë“œ</h3>
            
            <!-- 3D ì•„ë°”íƒ€ ì»¨í…Œì´ë„ˆ -->
            <div id="avatar-container">
            </div>
            <!-- ê°ì • ì œì–´ -->
            <div class="emotion-controls">
                <button class="emotion-btn happy" onclick="setAvatarEmotion('happy')">ğŸ˜Š ê¸°ì¨</button>
                <button class="emotion-btn neutral" onclick="setAvatarEmotion('neutral')">ğŸ˜ ì¤‘ë¦½</button>
                <button class="emotion-btn excited" onclick="setAvatarEmotion('excited')">ğŸ¤© í¥ë¶„</button>
                <button class="emotion-btn thinking" onclick="setAvatarEmotion('thinking')">ğŸ¤” ìƒê°</button>
                <button class="emotion-btn sad" onclick="setAvatarEmotion('sad')">ğŸ˜¢ ìŠ¬í””</button>
            </div>
            
            <!-- ì•„ë°”íƒ€ì™€ ì§ì ‘ ëŒ€í™” -->
            <div class="avatar-chat">
                <div style="font-weight: bold; margin-bottom: 0.5rem; color: #5a67d8;">ğŸ’¬ ì•„ë°”íƒ€ì™€ ëŒ€í™”</div>
                <div id="avatar-messages" style="height: 200px; overflow-y: auto; border: 1px solid #e2e8f0; padding: 0.5rem; margin-bottom: 0.5rem; background: white; border-radius: 4px;"></div>
                <input type="text" id="avatar-chat-input" placeholder="ì•„ë°”íƒ€ì—ê²Œ ì§ì ‘ ë§í•´ë³´ì„¸ìš”..." onkeypress="handleAvatarKeyPress(event)">
                <button onclick="sendAvatarMessage()">ì „ì†¡</button>
            </div>
        </div>
    </div>

    <!-- Three.js for 3D Avatar -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- JavaScript -->
    <script>
        // ì „ì—­ ë³€ìˆ˜
        let socket;
        let selectedGoblins = new Set();
        let currentConversationId = null;
        let currentMode = 'deep';
        let isTeamMode = false;
        let lastMessageId = null;
        let selectedRating = 0;

        // ì„¸ì…˜ ê¸°ë°˜ conversation_id ê´€ë¦¬
        function getSessionConversationId() {
            const currentGoblinId = Array.from(selectedGoblins)[0];
            if (!currentGoblinId) return null;
            
            const sessionKey = `conversation_${currentGoblinId}`;
            let conversationId = sessionStorage.getItem(sessionKey);
            
            if (!conversationId) {
                // ìƒˆ ì„¸ì…˜ ìƒì„±
                conversationId = `session_${currentGoblinId}_${Date.now()}`;
                sessionStorage.setItem(sessionKey, conversationId);
                console.log(`ğŸ†• ìƒˆ ì„¸ì…˜ ì‹œì‘: ${conversationId}`);
            } else {
                console.log(`ğŸ”„ ê¸°ì¡´ ì„¸ì…˜ ê³„ì†: ${conversationId}`);
            }
            
            return conversationId;
        }

        // ìƒˆë¡œìš´ ëŒ€í™” ì„¸ì…˜ ì‹œì‘ (ë‹¤ë¥¸ ë„ê¹¨ë¹„ ì„ íƒì‹œ)
        function startNewSession() {
            const currentGoblinId = Array.from(selectedGoblins)[0];
            if (!currentGoblinId) return;
            
            const sessionKey = `conversation_${currentGoblinId}`;
            const conversationId = `session_${currentGoblinId}_${Date.now()}`;
            sessionStorage.setItem(sessionKey, conversationId);
            currentConversationId = conversationId;
            
            console.log(`ğŸ†• ìƒˆ ëŒ€í™” ì„¸ì…˜ ì‹œì‘: ${conversationId}`);
            
            // ì±„íŒ… í™”ë©´ ì´ˆê¸°í™”
            const messagesContainer = document.getElementById('chat-messages');
            if (messagesContainer) {
                messagesContainer.innerHTML = '';
            }
        }

        // ì‚¬ìš©ìê°€ ìˆ˜ë™ìœ¼ë¡œ ìƒˆ ëŒ€í™” ì‹œì‘
        function startNewChatSession() {
            const currentGoblinId = Array.from(selectedGoblins)[0];
            if (!currentGoblinId) {
                showToast('ë¨¼ì € ë„ê¹¨ë¹„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”', 'error');
                return;
            }
            
            // í™•ì¸ ëŒ€í™”ìƒì
            if (confirm('ìƒˆë¡œìš´ ëŒ€í™”ë¥¼ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ì „ ëŒ€í™” ë‚´ìš©ì€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.')) {
                startNewSession();
                showToast('ìƒˆë¡œìš´ ëŒ€í™”ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ†•');
            }
        }

        // Socket.IO ì—°ê²° (ì„ì‹œ ë¹„í™œì„±í™”)
        function initSocket() {
            console.log('Socket.IO ì—°ê²° ë¹„í™œì„±í™”ë¨ - ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œ');
            // socket = io();
            
            // socket.on('connect', function() {
            //     console.log('ì„œë²„ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤');
            //     showToast('ë„ê¹¨ë¹„ë§ˆì„ì¥í„°ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰');
            // });
            
            // socket.on('connected', function(data) {
            //     console.log('ì—°ê²° í™•ì¸:', data);
            // });
            
            // socket.on('chat_response', function(data) {
            //     handleChatResponse(data);
            // });
            
            // socket.on('team_response', function(data) {
            //     handleTeamResponse(data);
            // });
            
            // socket.on('feedback_result', function(data) {
            //     handleFeedbackResult(data);
            // });
            
            // socket.on('performance_update', function(data) {
            //     updatePerformanceStats(data);
            // });
            
            // socket.on('disconnect', function() {
            //     console.log('ì„œë²„ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤');
            //     showToast('ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤', 'error');
            // });
        }

        // ë„ê¹¨ë¹„ ëª©ë¡ ë¡œë“œ
        async function loadGoblins() {
            try {
                const response = await fetch('/api/goblins');
                const data = await response.json();
                
                if (data.status === 'success') {
                    displayGoblins(data.experts);
                } else {
                    console.error('ë„ê¹¨ë¹„ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', data.error);
                }
            } catch (error) {
                console.error('ë„ê¹¨ë¹„ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ë„ê¹¨ë¹„ ëª©ë¡ í‘œì‹œ
        function displayGoblins(experts) {
            const goblinList = document.getElementById('goblin-list');
            goblinList.innerHTML = '';
            
            experts.forEach((expert) => {
                const goblinCard = document.createElement('div');
                goblinCard.className = 'goblin-card';
                goblinCard.dataset.goblinId = expert.id;
                
                // ë¬´ë£Œ/ìœ ë£Œ í‘œì‹œ
                const priceDisplay = expert.free ? 'ğŸ†“ ë¬´ë£Œ' : `â‚©${expert.price.toLocaleString()}`;
                
                goblinCard.innerHTML = `
                    <div class="goblin-name">${expert.name}</div>
                    <div class="goblin-specialty">${expert.specialty}</div>
                    <div class="goblin-personality">${expert.personality}</div>
                    <div class="goblin-price">${priceDisplay}</div>
                `;
                
                goblinCard.onclick = () => selectGoblin(expert.id, expert);
                goblinList.appendChild(goblinCard);
            });
        }

        // ë„ê¹¨ë¹„ ì„ íƒ
        function selectGoblin(goblinId, goblinInfo) {
            // ë‹¨ì¼ ëª¨ë“œì¼ ë•Œ
            if (!isTeamMode) {
                // ê¸°ì¡´ ì„ íƒ í•´ì œ
                document.querySelectorAll('.goblin-card').forEach(card => {
                    card.classList.remove('selected');
                });
                
                // ìƒˆë¡œìš´ ì„ íƒ
                document.querySelector(`[data-goblin-id="${goblinId}"]`).classList.add('selected');
                
                // ì´ì „ ë„ê¹¨ë¹„ì™€ ë‹¤ë¥¸ ê²½ìš°ì—ë§Œ ìƒˆ ì„¸ì…˜ ì‹œì‘
                const previousGoblin = Array.from(selectedGoblins)[0];
                selectedGoblins.clear();
                selectedGoblins.add(goblinId);
                
                if (previousGoblin !== goblinId) {
                    // ë‹¤ë¥¸ ë„ê¹¨ë¹„ ì„ íƒì‹œ ìƒˆ ì„¸ì…˜ ì‹œì‘
                    startNewSession();
                    console.log(`ğŸ”„ ë„ê¹¨ë¹„ ë³€ê²½: ${previousGoblin} â†’ ${goblinId}`);
                } else {
                    // ê°™ì€ ë„ê¹¨ë¹„ë©´ ê¸°ì¡´ ì„¸ì…˜ ìœ ì§€
                    currentConversationId = getSessionConversationId();
                }
                
                // ì±„íŒ… ì œëª© ì—…ë°ì´íŠ¸
                document.getElementById('chat-title').textContent = `ğŸ’¬ ${goblinInfo.name}ê³¼ ëŒ€í™” ì¤‘`;
                
                // ìƒˆ ëŒ€í™” ë²„íŠ¼ í‘œì‹œ
                document.getElementById('new-chat-btn').style.display = 'block';
                
                // ì±„íŒ… ì…ë ¥ í™œì„±í™”
                document.getElementById('chat-input').disabled = false;
                document.getElementById('send-btn').disabled = false;
                
            } else {
                // íŒ€ ëª¨ë“œì¼ ë•Œ
                const card = document.querySelector(`[data-goblin-id="${goblinId}"]`);
                if (selectedGoblins.has(goblinId)) {
                    selectedGoblins.delete(goblinId);
                    card.classList.remove('selected');
                } else if (selectedGoblins.size < 5) { // ìµœëŒ€ 5ëª…
                    selectedGoblins.add(goblinId);
                    card.classList.add('selected');
                }
                
                updateSelectedCount();
            }
        }

        // ì„ íƒëœ ë„ê¹¨ë¹„ ìˆ˜ ì—…ë°ì´íŠ¸
        function updateSelectedCount() {
            document.getElementById('selected-count').textContent = selectedGoblins.size;
        }

        // íŒ€ ëª¨ë“œ ì‹œì‘
        function startTeamMode() {
            if (selectedGoblins.size === 0) {
                showToast('ë„ê¹¨ë¹„ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”', 'error');
                return;
            }
            
            isTeamMode = true;
            const goblinNames = Array.from(selectedGoblins).map(id => {
                const card = document.querySelector(`[data-goblin-id="${id}"]`);
                return card.querySelector('.goblin-name').textContent;
            }).join(', ');
            
            document.getElementById('chat-title').textContent = `ğŸ¤ íŒ€ í˜‘ì—…: ${goblinNames}`;
            document.getElementById('chat-input').disabled = false;
            document.getElementById('send-btn').disabled = false;
            
            currentConversationId = null;
        }

        // ê²°ì œ í˜ì´ì§€ë¡œ ì´ë™
        function goToPayment() {
            window.open('/payment', '_blank');
        }

        // ëŒ€í™” ëª¨ë“œ ë³€ê²½
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentMode = btn.dataset.mode;
            };
        });

        // ë©”ì‹œì§€ ì „ì†¡
        function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message) return;
            if (selectedGoblins.size === 0) {
                showToast('ë„ê¹¨ë¹„ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”', 'error');
                return;
            }
            
            // ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ
            addMessage('user', message);
            
            // ë¡œë”© ë©”ì‹œì§€ í‘œì‹œ
            const loadingId = addLoadingMessage();
            
            // ì…ë ¥ ë¹„í™œì„±í™”
            input.disabled = true;
            document.getElementById('send-btn').disabled = true;
            
            if (isTeamMode && selectedGoblins.size > 1) {
                // íŒ€ ì±„íŒ… (ì‹œë®¬ë ˆì´ì…˜)
                console.log('íŒ€ ì±„íŒ… ì‹œë®¬ë ˆì´ì…˜:', {
                    goblin_ids: Array.from(selectedGoblins),
                    message: message,
                    conversation_id: currentConversationId
                });
                
                // ì‹œë®¬ë ˆì´ì…˜ ì‘ë‹µ
                setTimeout(() => {
                    simulateTeamResponse(message, Array.from(selectedGoblins));
                }, 1000);
                
            } else {
                // ê°œë³„ ì±„íŒ… (ì‹œë®¬ë ˆì´ì…˜)
                const goblinId = Array.from(selectedGoblins)[0];
                console.log('ê°œë³„ ì±„íŒ… ì‹œë®¬ë ˆì´ì…˜:', {
                    goblin_id: goblinId,
                    message: message,
                    conversation_id: currentConversationId,
                    mode: currentMode
                });
                
                // ê³ ê¸‰ AI API í˜¸ì¶œ
                setTimeout(() => {
                    callAdvancedAI(message, goblinId);
                }, 1000);
            }
            
            input.value = '';
        }

        // ì±„íŒ… ì‘ë‹µ ì²˜ë¦¬
        function handleChatResponse(data) {
            removeLoadingMessage();
            
            if (data && data.success && data.result) {
                const result = data.result;
                if (result.response) {
                    addMessage('goblin', result.response);
                    
                    currentConversationId = result.conversation_id || 'sim_' + Date.now();
                    lastMessageId = 'msg_' + Date.now();
                    
                    // í”¼ë“œë°± ë²„íŠ¼ í™œì„±í™”
                    const feedbackBtn = document.querySelector('.feedback-btn');
                    if (feedbackBtn) {
                        feedbackBtn.disabled = false;
                    }
                    
                    // ì „ë¬¸ê°€ ì •ë³´ í‘œì‹œ (ì„ íƒì )
                    if (result.selected_experts) {
                        addSystemMessage(`ğŸ¯ ì°¸ì—¬ ì „ë¬¸ê°€: ${result.selected_experts.join(', ')}`);
                    }
                } else {
                    addMessage('goblin', 'âŒ ì‘ë‹µ ë°ì´í„°ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }
            } else {
                const errorMsg = data && data.error ? data.error : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                addMessage('goblin', `âŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${errorMsg}`);
            }
            
            // ì…ë ¥ ë‹¤ì‹œ í™œì„±í™”
            document.getElementById('chat-input').disabled = false;
            document.getElementById('send-btn').disabled = false;
        }

        // íŒ€ ì‘ë‹µ ì²˜ë¦¬
        function handleTeamResponse(data) {
            removeLoadingMessage();
            
            if (data.success) {
                const result = data.result;
                addMessage('goblin', result.team_synthesis);
                
                currentConversationId = result.conversation_id;
                lastMessageId = 'msg_' + Date.now();
                
                // í”¼ë“œë°± ë²„íŠ¼ í™œì„±í™”
                document.querySelector('.feedback-btn').disabled = false;
            } else {
                addMessage('goblin', `âŒ íŒ€ í˜‘ì—… ì˜¤ë¥˜: ${data.error}`);
            }
            
            // ì…ë ¥ ë‹¤ì‹œ í™œì„±í™”
            document.getElementById('chat-input').disabled = false;
            document.getElementById('send-btn').disabled = false;
        }

        // ë©”ì‹œì§€ ì¶”ê°€
        function addMessage(type, content) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const now = new Date();
            const timeString = now.toLocaleTimeString('ko-KR', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            messageDiv.innerHTML = `
                <div class="message-bubble">${content}</div>
                <div class="message-time">${timeString}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì¶”ê°€
        function addSystemMessage(content) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message goblin';
            messageDiv.style.opacity = '0.7';
            
            messageDiv.innerHTML = `
                <div class="message-bubble" style="background: #f0f9ff; border-color: #0ea5e9; font-size: 0.9em;">
                    ${content}
                </div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // ë¡œë”© ë©”ì‹œì§€ ì¶”ê°€
        function addLoadingMessage() {
            const messagesContainer = document.getElementById('chat-messages');
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message goblin loading-message';
            loadingDiv.id = 'loading-message';
            
            loadingDiv.innerHTML = `
                <div class="message-bubble">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        ë„ê¹¨ë¹„ê°€ ìƒê° ì¤‘ì…ë‹ˆë‹¤...
                    </div>
                </div>
            `;
            
            messagesContainer.appendChild(loadingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            return 'loading-message';
        }

        // ë¡œë”© ë©”ì‹œì§€ ì œê±°
        function removeLoadingMessage() {
            const loadingMessage = document.getElementById('loading-message');
            if (loadingMessage) {
                loadingMessage.remove();
            }
        }

        // ë³„ì  ì„ íƒ
        document.querySelectorAll('.star').forEach(star => {
            star.onclick = () => {
                const rating = parseInt(star.dataset.rating);
                selectedRating = rating;
                
                document.querySelectorAll('.star').forEach((s, index) => {
                    s.classList.toggle('active', index < rating);
                });
            };
        });

        // í”¼ë“œë°± ì œì¶œ
        function submitFeedback() {
            if (!currentConversationId || !lastMessageId || selectedRating === 0) {
                showToast('í”¼ë“œë°±ì„ ì œì¶œí•˜ë ¤ë©´ ëŒ€í™”ì™€ ë³„ì ì´ í•„ìš”í•©ë‹ˆë‹¤', 'error');
                return;
            }
            
            const goblinId = Array.from(selectedGoblins)[0];
            
            // socket.emit('feedback', {
            //     goblin_id: goblinId,
            //     conversation_id: currentConversationId,
            //     message_id: lastMessageId,
            //     rating: selectedRating,
            //     feedback_type: selectedRating >= 4 ? 'helpful' : 'negative',
            //     comment: ''
            // });
            
            // í”¼ë“œë°± ì‹œë®¬ë ˆì´ì…˜
            console.log('í”¼ë“œë°± ì‹œë®¬ë ˆì´ì…˜:', {
                goblin_id: goblinId,
                rating: selectedRating
            });
            
            setTimeout(() => {
                handleFeedbackResult({
                    success: true,
                    rating: selectedRating
                });
            }, 500);
        }

        // í”¼ë“œë°± ê²°ê³¼ ì²˜ë¦¬
        function handleFeedbackResult(data) {
            if (data.success) {
                showToast(`í”¼ë“œë°±ì´ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤! (${data.rating}â­)`);
                
                // ë³„ì  ì´ˆê¸°í™”
                selectedRating = 0;
                document.querySelectorAll('.star').forEach(s => s.classList.remove('active'));
                document.querySelector('.feedback-btn').disabled = true;
            } else {
                showToast(`í”¼ë“œë°± ì œì¶œ ì‹¤íŒ¨: ${data.error}`, 'error');
            }
        }

        // ì„±ëŠ¥ í†µê³„ ì—…ë°ì´íŠ¸
        function updatePerformanceStats(data) {
            try {
                // ì•ˆì „í•œ ìš”ì†Œ ì—…ë°ì´íŠ¸
                const totalGoblinsEl = document.getElementById('total-goblins');
                if (totalGoblinsEl && data.performance) {
                    totalGoblinsEl.textContent = data.performance.total_goblins || 39;
                }
                
                const activeUsersEl = document.getElementById('active-users');
                if (activeUsersEl) {
                    activeUsersEl.textContent = data.active_users || 0;
                }
                
                console.log('ğŸ“Š ì„±ëŠ¥ ë°ì´í„° ì—…ë°ì´íŠ¸ ì™„ë£Œ:', data);
            } catch (error) {
                console.warn('âš ï¸ ì„±ëŠ¥ ë°ì´í„° ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
            }
        }

        // í† ìŠ¤íŠ¸ ì•Œë¦¼ í‘œì‹œ
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            // ì• ë‹ˆë©”ì´ì…˜
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }

        // Enter í‚¤ë¡œ ë©”ì‹œì§€ ì „ì†¡
        document.getElementById('chat-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // ì‹¤ì œ 1000ì ê³ ê¸‰ AI API í˜¸ì¶œ
        async function callAdvancedAI(message, goblinId) {
            try {
                // ì„¸ì…˜ ê¸°ë°˜ conversation_id ê°€ì ¸ì˜¤ê¸°
                const sessionConversationId = getSessionConversationId();
                
                const response = await fetch('/api/chat/advanced', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        goblin_id: parseInt(goblinId),
                        mode: currentMode,  // ëª¨ë“œ ì •ë³´ ì¶”ê°€
                        conversation_id: sessionConversationId  // ì„¸ì…˜ ID ì „ì†¡
                    })
                });

                const data = await response.json();
                
                if (data.status === 'success') {
                    console.log('ğŸ‰ 1000ì AI ì‘ë‹µ ìƒì„± ì™„ë£Œ:', data.result.response_length + 'ì');
                    
                    handleChatResponse({
                        success: true,
                        result: {
                            response: data.result.response,
                            conversation_id: data.result.conversation_id,
                            goblin_id: goblinId,
                            expert_type: data.result.expert_type,
                            response_length: data.result.response_length,
                            timestamp: data.result.timestamp
                        }
                    });
                } else {
                    throw new Error(data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('âŒ ê³ ê¸‰ AI í˜¸ì¶œ ì‹¤íŒ¨:', error);
                
                // ì‹¤íŒ¨ ì‹œ ê¸°ì¡´ ì‹œë®¬ë ˆì´ì…˜ìœ¼ë¡œ í´ë°±
                simulateAdvancedResponse(message, goblinId);
            }
        }

        // ê³ ê¸‰ AI ì‹œë®¬ë ˆì´ì…˜ í•¨ìˆ˜ë“¤
        function simulateAdvancedResponse(message, goblinId) {
            // ê³ ê¸‰ AI ë¶„ì„ í•¨ìˆ˜ë“¤
            const analyzeMessage = (msg) => {
                const emotions = {
                    curious: ['ë­ì˜ˆìš”', 'ë¨¸ì˜ˆìš”', 'ë€?', 'ì´ë€?', 'ë­”ì§€', 'ì•Œë ¤ì£¼ì„¸ìš”', 'ê¶ê¸ˆ', '?'],
                    excited: ['!', 'ì™€', 'ëŒ€ë°•', 'ì‹ ê¸°', 'ì¬ë¯¸', 'ì¢‹ë‹¤', 'ë©‹ì§€'],
                    confused: ['ëª¨ë¥´ê² ', 'í—·ê°ˆ', 'ì–´ë ¤ì›Œ', 'ë³µì¡', 'ì´í•´ ì•ˆ'],
                    urgent: ['ë¹¨ë¦¬', 'ê¸‰í•˜', 'ì§€ê¸ˆ', 'ë‹¹ì¥', 'ë„ì™€ì£¼ì„¸ìš”'],
                    polite: ['ë¶€íƒ', 'ê°ì‚¬', 'ì£„ì†¡', 'ì‹¤ë¡€', 'ì •ì¤‘']
                };
                
                let detectedEmotion = 'neutral';
                for (const [emotion, keywords] of Object.entries(emotions)) {
                    if (keywords.some(keyword => msg.includes(keyword))) {
                        detectedEmotion = emotion;
                        break;
                    }
                }
                
                const complexity = msg.length > 10 ? 'complex' : 'simple';
                const questionType = msg.includes('?') || msg.includes('ë€') || msg.includes('ë­') ? 'question' : 'statement';
                
                return { emotion: detectedEmotion, complexity, questionType };
            };

            const generateDetailedResponse = (msg, analysis, goblinId) => {
                // ë„ê¹¨ë¹„ë³„ ì „ë¬¸ ì§€ì‹ ê¸°ë°˜ ìƒì„¸ ì‘ë‹µ
                const expertResponses = {
                    1: { // AIì „ë¬¸ê°€
                        intro: "ğŸ¤– AI ì „ë¬¸ê°€ë¡œì„œ ë¶„ì„í•´ë“œë¦¬ê² ìŠµë‹ˆë‹¤.",
                        knowledge: {
                            "ì¸ê³µì§€ëŠ¥": `ì¸ê³µì§€ëŠ¥(Artificial Intelligence)ì€ ì¸ê°„ì˜ ì§€ëŠ¥ì„ ê¸°ê³„ë¡œ êµ¬í˜„í•˜ëŠ” ê¸°ìˆ ì…ë‹ˆë‹¤.

ğŸ“ **í•µì‹¬ êµ¬ì„±ìš”ì†Œ:**
â€¢ ë¨¸ì‹ ëŸ¬ë‹(Machine Learning): ë°ì´í„°ë¡œë¶€í„° íŒ¨í„´ì„ í•™ìŠµ
â€¢ ë”¥ëŸ¬ë‹(Deep Learning): ì‹ ê²½ë§ì„ í†µí•œ ë³µì¡í•œ í•™ìŠµ
â€¢ ìì—°ì–´ì²˜ë¦¬(NLP): ì¸ê°„ì˜ ì–¸ì–´ë¥¼ ì´í•´í•˜ê³  ìƒì„±
â€¢ ì»´í“¨í„° ë¹„ì „: ì´ë¯¸ì§€ì™€ ì˜ìƒì„ ì¸ì‹í•˜ê³  ë¶„ì„

ğŸ”¬ **í˜„ì¬ í™œìš© ë¶„ì•¼:**
â€¢ ì˜ë£Œì§„ë‹¨, ììœ¨ì£¼í–‰, ì¶”ì²œì‹œìŠ¤í…œ, ë²ˆì—­ì„œë¹„ìŠ¤
â€¢ ìŒì„±ì¸ì‹, ì´ë¯¸ì§€ìƒì„±, ê²Œì„AI, ë¡œë´‡ê³µí•™

ğŸ’¡ **ë¯¸ë˜ ì „ë§:**
AGI(ì¼ë°˜ì¸ê³µì§€ëŠ¥) ê°œë°œì„ í†µí•´ ì¸ê°„ê³¼ ê°™ì€ ë²”ìš©ì  ì‚¬ê³ ëŠ¥ë ¥ì„ ê°–ì¶˜ AIê°€ ë“±ì¥í•  ê²ƒìœ¼ë¡œ ì˜ˆìƒë©ë‹ˆë‹¤.`,
                            "ë¨¸ì‹ ëŸ¬ë‹": `ë¨¸ì‹ ëŸ¬ë‹ì€ ë°ì´í„°ë¥¼ í†µí•´ ì»´í“¨í„°ê°€ ìŠ¤ìŠ¤ë¡œ í•™ìŠµí•˜ëŠ” AIì˜ í•µì‹¬ ê¸°ìˆ ì…ë‹ˆë‹¤.

ğŸ¯ **í•™ìŠµ ë°©ì‹:**
â€¢ ì§€ë„í•™ìŠµ: ì •ë‹µì´ ìˆëŠ” ë°ì´í„°ë¡œ í•™ìŠµ
â€¢ ë¹„ì§€ë„í•™ìŠµ: íŒ¨í„´ ë°œê²¬ì„ í†µí•œ ììœ¨í•™ìŠµ
â€¢ ê°•í™”í•™ìŠµ: ì‹œí–‰ì°©ì˜¤ë¥¼ í†µí•œ ìµœì í™” í•™ìŠµ

âš™ï¸ **ì£¼ìš” ì•Œê³ ë¦¬ì¦˜:**
â€¢ ì„ í˜•íšŒê·€, ì˜ì‚¬ê²°ì •íŠ¸ë¦¬, ëœë¤í¬ë ˆìŠ¤íŠ¸
â€¢ SVM, í´ëŸ¬ìŠ¤í„°ë§, ì‹ ê²½ë§

ğŸ“Š **í™œìš© ì˜ˆì‹œ:**
ìŠ¤íŒ¸ë©”ì¼ í•„í„°ë§, ì£¼ì‹ ì˜ˆì¸¡, ê³ ê° ì„¸ë¶„í™”, ì¶”ì²œì‹œìŠ¤í…œ ë“±`
                        }
                    },
                    2: { // ë°ì´í„°ê³¼í•™ë°•ì‚¬
                        intro: "ğŸ“Š ë°ì´í„° ê³¼í•™ ê´€ì ì—ì„œ ì‹¬ì¸µ ë¶„ì„í•´ë“œë¦¬ê² ìŠµë‹ˆë‹¤.",
                        knowledge: {
                            "ë°ì´í„°": `ë°ì´í„°ëŠ” í˜„ëŒ€ ë””ì§€í„¸ ì‚¬íšŒì˜ ê°€ì¥ ì¤‘ìš”í•œ ìì›ì…ë‹ˆë‹¤.

ğŸ“ˆ **ë°ì´í„° ìœ í˜•:**
â€¢ ì •í˜•ë°ì´í„°: í‘œ í˜•íƒœì˜ êµ¬ì¡°í™”ëœ ë°ì´í„°
â€¢ ë°˜ì •í˜•ë°ì´í„°: XML, JSON ê°™ì€ ë°˜êµ¬ì¡°í™” ë°ì´í„°  
â€¢ ë¹„ì •í˜•ë°ì´í„°: í…ìŠ¤íŠ¸, ì´ë¯¸ì§€, ì˜ìƒ ë“±

ğŸ” **ë¶„ì„ í”„ë¡œì„¸ìŠ¤:**
1. ìˆ˜ì§‘(Collection) â†’ 2. ì •ì œ(Cleaning) â†’ 3. íƒìƒ‰(EDA) 
4. ëª¨ë¸ë§(Modeling) â†’ 5. ê²€ì¦(Validation) â†’ 6. ë°°í¬(Deploy)

ğŸ’¹ **ë¹„ì¦ˆë‹ˆìŠ¤ ê°€ì¹˜:**
ë°ì´í„° ê¸°ë°˜ ì˜ì‚¬ê²°ì •ìœ¼ë¡œ ë§¤ì¶œ 15-20% ì¦ê°€, ë¹„ìš© 10-15% ì ˆê° íš¨ê³¼ê°€ ì…ì¦ë˜ì—ˆìŠµë‹ˆë‹¤.`
                        }
                    }
                };

                const expert = expertResponses[goblinId];
                if (!expert) {
                    return `ì „ë¬¸ê°€ë¡œì„œ "${msg}"ì— ëŒ€í•´ ìì„¸íˆ ì„¤ëª…ë“œë¦¬ê² ìŠµë‹ˆë‹¤. ì´ëŠ” ë§¤ìš° í¥ë¯¸ë¡œìš´ ì£¼ì œì´ë©°, ì‹¤ë¬´ ê²½í—˜ì„ ë°”íƒ•ìœ¼ë¡œ ë‹¨ê³„ë³„ë¡œ ì ‘ê·¼í•´ë³´ê² ìŠµë‹ˆë‹¤.`;
                }

                // í‚¤ì›Œë“œ ë§¤ì¹­ìœ¼ë¡œ ì „ë¬¸ ì§€ì‹ ì°¾ê¸°
                for (const [keyword, content] of Object.entries(expert.knowledge)) {
                    if (msg.includes(keyword)) {
                        return `${expert.intro}

${content}

ğŸ’¬ ë” ê¶ê¸ˆí•œ ì ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ë§ì”€í•´ì£¼ì„¸ìš”!`;
                    }
                }

                return `${expert.intro}

"${msg}"ì— ëŒ€í•´ ë” êµ¬ì²´ì ìœ¼ë¡œ ì§ˆë¬¸í•´ì£¼ì‹œë©´ ì „ë¬¸ ì§€ì‹ì„ ë°”íƒ•ìœ¼ë¡œ ìƒì„¸íˆ ì„¤ëª…ë“œë¦¬ê² ìŠµë‹ˆë‹¤.`;
            };

            // ë©”ì‹œì§€ ë¶„ì„
            const analysis = analyzeMessage(message);
            console.log('ğŸ“Š ë©”ì‹œì§€ ë¶„ì„ ê²°ê³¼:', analysis);

            // ê°ì •ì— ë”°ë¥¸ ì‘ë‹µ ì¡°ì •
            let responsePrefix = '';
            switch(analysis.emotion) {
                case 'curious':
                    responsePrefix = 'ğŸ¤” ê¶ê¸ˆì¦ì´ ëŠê»´ì§€ëŠ” ì§ˆë¬¸ì´ë„¤ìš”! ';
                    break;
                case 'excited':
                    responsePrefix = 'ğŸ‰ ì—´ì •ì ì¸ ì—ë„ˆì§€ê°€ ì „í•´ì§‘ë‹ˆë‹¤! ';
                    break;
                case 'confused':
                    responsePrefix = 'ğŸ˜Š ë³µì¡í•´ ë³´ì´ì§€ë§Œ ì°¨ê·¼ì°¨ê·¼ ì„¤ëª…í•´ë“œë¦´ê²Œìš”! ';
                    break;
                case 'urgent':
                    responsePrefix = 'âš¡ ê¸‰í•˜ì‹  ê²ƒ ê°™ìœ¼ë‹ˆ í•µì‹¬ë¶€í„° ë§ì”€ë“œë¦¬ê² ìŠµë‹ˆë‹¤! ';
                    break;
            }

            // ìƒì„¸í•œ ì‘ë‹µ ìƒì„±
            const detailedResponse = generateDetailedResponse(message, analysis, goblinId);
            const finalResponse = responsePrefix + detailedResponse;

            handleChatResponse({
                success: true,
                result: {
                    response: finalResponse,
                    conversation_id: 'sim_' + Date.now(),
                    goblin_id: goblinId,
                    timestamp: new Date().toISOString(),
                    analysis: analysis
                }
            });
        }

        // ì‹œë®¬ë ˆì´ì…˜ í•¨ìˆ˜ë“¤
        function simulateResponse(message, goblinId) {
            // ë„ê¹¨ë¹„ë³„ ê°œì„± ìˆëŠ” ì‘ë‹µ
            const goblinResponses = {
                1: [ // AIì „ë¬¸ê°€
                    `ğŸ¤– ì•ˆë…•í•˜ì„¸ìš”! AI ì „ë¬¸ê°€ì…ë‹ˆë‹¤. "${message}"ì— ëŒ€í•´ ë°ì´í„° ê¸°ë°˜ìœ¼ë¡œ ë¶„ì„í•´ë“œë¦´ê²Œìš”!`,
                    `ğŸ’¡ í¥ë¯¸ë¡œìš´ ì§ˆë¬¸ì´ë„¤ìš”! ë¨¸ì‹ ëŸ¬ë‹ ê´€ì ì—ì„œ "${message}"ë¥¼ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.`,
                    `ğŸ” "${message}"... ì´ê±´ ì•Œê³ ë¦¬ì¦˜ìœ¼ë¡œ ìµœì í™”í•  ìˆ˜ ìˆì„ ê²ƒ ê°™ì€ë°ìš”?`,
                    `âš¡ í˜ì‹ ì ì¸ ì•„ì´ë””ì–´êµ°ìš”! "${message}"ë¥¼ AI ê¸°ìˆ ë¡œ ì–´ë–»ê²Œ í•´ê²°í• ì§€ í•¨ê»˜ ê³ ë¯¼í•´ë´ìš”.`
                ],
                2: [ // ë°ì´í„°ê³¼í•™ë°•ì‚¬
                    `ğŸ“Š ì•ˆë…•í•˜ì„¸ìš”! ë°ì´í„°ë¡œ ë§í•˜ëŠ” ê³¼í•™ìì…ë‹ˆë‹¤. "${message}" ë°ì´í„°ë¥¼ ë¶„ì„í•´ë³¼ê¹Œìš”?`,
                    `ğŸ“ˆ í†µê³„ì ìœ¼ë¡œ ë´¤ì„ ë•Œ "${message}"ëŠ” ë§¤ìš° í¥ë¯¸ë¡œìš´ íŒ¨í„´ì„ ë³´ì´ë„¤ìš”!`,
                    `ğŸ”¢ "${message}"ì— ìˆ¨ê²¨ì§„ ì¸ì‚¬ì´íŠ¸ë¥¼ ì°¾ì•„ë³´ê² ìŠµë‹ˆë‹¤. ìˆ˜ì¹˜ë¡œ ì¦ëª…í•´ë“œë¦´ê²Œìš”!`,
                    `ğŸ’¹ ë¹…ë°ì´í„° ë¶„ì„ ê²°ê³¼, "${message}"ëŠ” íŠ¸ë Œë“œ ìƒìŠ¹ ì¤‘ì…ë‹ˆë‹¤!`
                ],
                3: [ // ë¸”ë¡ì²´ì¸ê°œë°œì
                    `â›“ï¸ ë¸”ë¡ì²´ì¸ ì„¸ê³„ì— ì˜¤ì‹  ê±¸ í™˜ì˜í•©ë‹ˆë‹¤! "${message}"ë¥¼ íƒˆì¤‘ì•™í™”ë¡œ í•´ê²°í•´ë³¼ê¹Œìš”?`,
                    `ğŸ’ "${message}"... ì´ê±° ìŠ¤ë§ˆíŠ¸ ì»¨íŠ¸ë™íŠ¸ë¡œ ìë™í™”í•˜ë©´ ì–´ë–¨ê¹Œìš”?`,
                    `ğŸš€ ë¯¸ë˜ì§€í–¥ì  ì§ˆë¬¸ì´ë„¤ìš”! "${message}"ë¥¼ Web3ìœ¼ë¡œ í˜ì‹ í•´ë³´ê² ìŠµë‹ˆë‹¤.`,
                    `ğŸ” ë³´ì•ˆê³¼ íˆ¬ëª…ì„±ì´ í•µì‹¬ì´ì£ . "${message}"ë¥¼ ë¸”ë¡ì²´ì¸ìœ¼ë¡œ ê²€ì¦í•´ë“œë¦´ê²Œìš”!`
                ],
                4: [ // ë³´ì•ˆì „ë¬¸ê°€
                    `ğŸ›¡ï¸ ë³´ì•ˆ ì „ë¬¸ê°€ì…ë‹ˆë‹¤! "${message}"ì˜ ë³´ì•ˆ ì·¨ì•½ì ë¶€í„° ì ê²€í•´ë³¼ê¹Œìš”?`,
                    `ğŸ”’ "${message}"... í˜¹ì‹œ í•´í‚¹ ìœ„í—˜ì€ ì—†ëŠ”ì§€ ë¨¼ì € í™•ì¸í•´ë´…ì‹œë‹¤!`,
                    `âš ï¸ ì‚¬ì´ë²„ ë³´ì•ˆ ê´€ì ì—ì„œ "${message}"ëŠ” ì‹ ì¤‘í•˜ê²Œ ì ‘ê·¼í•´ì•¼ í•  ê²ƒ ê°™ë„¤ìš”.`
                ],
                10: [ // ì¸ê³µì§€ëŠ¥ë°•ì‚¬ë„ê¹¨ë¹„
                    `ğŸ“ AI ë°•ì‚¬ì…ë‹ˆë‹¤! "${message}"ë¥¼ í•™ìˆ ì ìœ¼ë¡œ ì‹¬ì¸µ ë¶„ì„í•´ë“œë¦¬ê² ìŠµë‹ˆë‹¤!`,
                    `ğŸ“š ì—°êµ¬ ë…¼ë¬¸ ê¸°ë°˜ìœ¼ë¡œ "${message}"ì— ëŒ€í•œ ìµœì‹  ì´ë¡ ì„ ì„¤ëª…í•´ë“œë¦´ê²Œìš”!`,
                    `ğŸ§  ë”¥ëŸ¬ë‹ ì•Œê³ ë¦¬ì¦˜ìœ¼ë¡œ "${message}"ë¥¼ ëª¨ë¸ë§í•´ë³¼ê¹Œìš”?`
                ],
                11: [ // ê²½ì˜í•™ë°•ì‚¬ë„ê¹¨ë¹„
                    `ğŸ’¼ ê²½ì˜ ì „ëµê°€ì…ë‹ˆë‹¤! "${message}"ë¥¼ ë¹„ì¦ˆë‹ˆìŠ¤ ê´€ì ì—ì„œ ë¶„ì„í•´ë³´ê² ìŠµë‹ˆë‹¤!`,
                    `ğŸ“‹ "${message}"... ì´ê±° ROI ê³„ì‚°í•´ë³´ê³  ì‹¤í–‰ ê³„íš ì„¸ì›Œë´…ì‹œë‹¤!`,
                    `ğŸ¯ ë¦¬ë”ì‹­ ê²½í—˜ìœ¼ë¡œ ë´¤ì„ ë•Œ, "${message}"ëŠ” ì „ëµì  ì ‘ê·¼ì´ í•„ìš”í•˜ë„¤ìš”!`
                ],
                12: [ // ì˜í•™ë°•ì‚¬ë„ê¹¨ë¹„
                    `âš•ï¸ ì˜í•™ë°•ì‚¬ì…ë‹ˆë‹¤! "${message}"ì™€ ê´€ë ¨ëœ ê±´ê°• ì¸¡ë©´ì„ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤!`,
                    `ğŸ©º ì „ë¬¸ì˜ ì…ì¥ì—ì„œ "${message}"ì— ëŒ€í•œ ì˜í•™ì  ì¡°ì–¸ì„ ë“œë¦´ê²Œìš”!`,
                    `ğŸ’Š "${message}"... ì˜ˆë°©ì´ ì¹˜ë£Œë³´ë‹¤ ì¤‘ìš”í•˜ë‹¤ëŠ” ê´€ì ì—ì„œ ì ‘ê·¼í•´ë´…ì‹œë‹¤!`
                ],
                17: [ // ì² í•™ë°•ì‚¬ë„ê¹¨ë¹„
                    `ğŸ¤” ì² í•™ìì˜ ê´€ì ì—ì„œ "${message}"ì˜ ë³¸ì§ˆì„ íƒêµ¬í•´ë³´ê² ìŠµë‹ˆë‹¤...`,
                    `ğŸ’­ "${message}"ë¼ëŠ” ê²ƒì€ ê³¼ì—° ë¬´ì—‡ì¼ê¹Œìš”? í•¨ê»˜ ì‚¬ìƒ‰í•´ë´…ì‹œë‹¤.`,
                    `ğŸŒŸ ì†Œí¬ë¼í…ŒìŠ¤ê°€ "${message}"ì— ëŒ€í•´ ë­ë¼ê³  í–ˆì„ê¹Œìš”? ì² í•™ì ìœ¼ë¡œ ì ‘ê·¼í•´ë´…ì‹œë‹¤!`
                ]
            };

            // ê¸°ë³¸ ì‘ë‹µ (ë‹¤ë¥¸ ë„ê¹¨ë¹„ë“¤ìš©)
            const defaultResponses = [
                `ì•ˆë…•í•˜ì„¸ìš”! ì „ë¬¸ê°€ ë„ê¹¨ë¹„ì…ë‹ˆë‹¤. "${message}"ì— ëŒ€í•´ ê¹Šì´ ìˆê²Œ ë‹µë³€ë“œë¦¬ê² ìŠµë‹ˆë‹¤! ğŸ§™â€â™‚ï¸`,
                `í¥ë¯¸ë¡œìš´ ì£¼ì œë„¤ìš”! "${message}"ëŠ” ì œ ì „ë¬¸ ë¶„ì•¼ì™€ ê´€ë ¨ì´ ê¹ŠìŠµë‹ˆë‹¤. ìì„¸íˆ ì„¤ëª…í•´ë“œë¦´ê²Œìš”! âœ¨`,
                `ì¢‹ì€ ì§ˆë¬¸ì…ë‹ˆë‹¤! "${message}"ì— ëŒ€í•œ ì‹¤ë¬´ ê²½í—˜ì„ ë°”íƒ•ìœ¼ë¡œ ì¡°ì–¸ë“œë¦¬ê² ìŠµë‹ˆë‹¤! ğŸ’«`,
                `"${message}"... ì´ê±° ì •ë§ ì¤‘ìš”í•œ í¬ì¸íŠ¸ë¥¼ ì§šìœ¼ì…¨ë„¤ìš”! í•¨ê»˜ ë¶„ì„í•´ë´…ì‹œë‹¤! ğŸ¯`,
                `ì „ë¬¸ê°€ë¡œì„œ "${message}"ì— ëŒ€í•´ ì²´ê³„ì ìœ¼ë¡œ ì ‘ê·¼í•´ë³´ê² ìŠµë‹ˆë‹¤! ğŸ”`,
                `"${message}"ëŠ” ìµœê·¼ í•«í•œ ì´ìŠˆì£ ! íŠ¸ë Œë“œì™€ í•¨ê»˜ ì„¤ëª…ë“œë¦´ê²Œìš”! ğŸ“ˆ`
            ];

            // íŠ¹ë³„í•œ ì¸ì‚¬ë§ ì²˜ë¦¬
            const greetings = ['ì•ˆë…•í•˜ì„¸ìš”', 'ì•ˆë…•', 'í•˜ì´', 'hi', 'hello', 'í—¬ë¡œ', 'ì¢‹ì€ ì•„ì¹¨', 'ì¢‹ì€ ì˜¤í›„', 'ì¢‹ì€ ì €ë…'];
            const isGreeting = greetings.some(greeting => 
                message.toLowerCase().includes(greeting.toLowerCase())
            );

            let responses;
            if (isGreeting) {
                // ì¸ì‚¬ë§ì— ëŒ€í•œ íŠ¹ë³„ ì‘ë‹µ
                const greetingResponses = [
                    `ì•ˆë…•í•˜ì„¸ìš”! ğŸ‘‹ ì €ëŠ” ì´ ë¶„ì•¼ ì „ë¬¸ê°€ ë„ê¹¨ë¹„ì…ë‹ˆë‹¤. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?`,
                    `ë°˜ê°‘ìŠµë‹ˆë‹¤! ğŸ˜Š ì˜¤ëŠ˜ì€ ì–´ë–¤ ê¶ê¸ˆí•œ ê²ƒì´ ìˆìœ¼ì‹ ê°€ìš”?`,
                    `ì•ˆë…•í•˜ì„¸ìš”! âœ¨ ì „ë¬¸ê°€ì˜ ì¡°ì–¸ì´ í•„ìš”í•˜ì‹œë©´ ì–¸ì œë“  ë§ì”€í•´ì£¼ì„¸ìš”!`,
                    `í•˜ì´! ğŸŒŸ ë„ê¹¨ë¹„ë§ˆì„ì— ì˜¤ì‹  ê±¸ í™˜ì˜í•©ë‹ˆë‹¤! ë¬´ì—‡ì„ ìƒë‹´í•´ë“œë¦´ê¹Œìš”?`,
                    `ì¢‹ì€ í•˜ë£¨ì˜ˆìš”! ğŸ˜„ ì œ ì „ë¬¸ ì§€ì‹ìœ¼ë¡œ ë„ì›€ì„ ë“œë¦´ ì¤€ë¹„ê°€ ë˜ì–´ìˆìŠµë‹ˆë‹¤!`
                ];
                responses = greetingResponses;
            } else {
                responses = goblinResponses[goblinId] || defaultResponses;
            }
            const randomResponse = responses[Math.floor(Math.random() * responses.length)];
            
            handleChatResponse({
                success: true,
                result: {
                    response: randomResponse,
                    conversation_id: 'sim_' + Date.now(),
                    goblin_id: goblinId,
                    timestamp: new Date().toISOString()
                }
            });
        }

        function simulateTeamResponse(message, goblinIds) {
            const teamResponse = `íŒ€ í˜‘ì—… ë‹µë³€: "${message}"ì— ëŒ€í•´ ${goblinIds.length}ëª…ì˜ ì „ë¬¸ê°€ê°€ í•¨ê»˜ ë‹µë³€ë“œë¦½ë‹ˆë‹¤. ë‹¤ì–‘í•œ ê´€ì ì—ì„œ ì¢…í•©ì ì¸ ì†”ë£¨ì…˜ì„ ì œê³µí•˜ê² ìŠµë‹ˆë‹¤.`;
            
            handleTeamResponse({
                success: true,
                responses: [{
                    goblin_id: goblinIds[0],
                    response: teamResponse,
                    timestamp: new Date().toISOString()
                }],
                team_summary: `${goblinIds.length}ëª… ì „ë¬¸ê°€ í˜‘ì—… ì™„ë£Œ`
            });
        }

        // 3D ì•„ë°”íƒ€ ì‹œìŠ¤í…œ ë³€ìˆ˜
        let scene, camera, renderer, avatar, light;
        let currentEmotion = 'neutral';
        let isAvatarInitialized = false;
        
        // ì–¼êµ´ í‘œì • ìš”ì†Œë“¤
        let leftEye, rightEye, mouth, leftPupil, rightPupil;
        
        // ê°ì • ë¶„ì„ ë° ì•„ë°”íƒ€ ì‹œìŠ¤í…œ í•¨ìˆ˜ë“¤
        function analyzeKoreanEmotion(text) {
            if (!text) return { emotion: 'neutral', confidence: 0.5 };
            
            const emotionKeywords = {
                happy: ['ê¸°ì˜', 'ê¸°ë»', 'í–‰ë³µ', 'ì¢‹', 'ì›ƒ', 'ì¦ê±°', 'ì‹ ë‚˜', 'ë§Œì¡±', 'ê°ì‚¬', 'ìµœê³ ', 'êµ¿', 'ì•¼í˜¸', 'ì™€ìš°', 'ëŒ€ë°•ì¢‹', 'ì§±'],
                sad: ['ìŠ¬í”„', 'ìŠ¬í¼', 'ìš°ìš¸', 'í˜ë“¤', 'ì•„í”„', 'ì™¸ë¡œ', 'ê´´ë¡œ', 'ì ˆë§', 'ì‹¤ë§', 'ëˆˆë¬¼', 'ìš¸ì–´', 'ì†ìƒ', 'ì•ˆíƒ€ê¹'],
                angry: ['í™”', 'í™”ë‚˜', 'ì§œì¦', 'ë¶„ë…¸', 'ì—´ë°›', 'ë¹¡ì³', 'ë¯¸ì³', 'ì•…', 'ì‹«ì–´', 'ì§œì¦ë‚˜', 'ë¶„í•´', 'í™”ë‚¬'],
                excited: ['ì‹ ë‚˜', 'í¥ë¶„', 'ë‘ê·¼', 'ê¸°ëŒ€', 'ì„¤ë ˆ', 'ì™€', 'ì˜¤ì˜¤', 'ëŒ€ë°•', 'ì™„ì „', 'ì©”ì–´'],
                thinking: ['ìƒê°', 'ê³ ë¯¼', 'ìŒ', 'í ', 'ê¸€ì„', 'ì–´ë–¨ê¹Œ', 'ëª¨ë¥´ê² ', 'ê¶ê¸ˆ', 'í•œë²ˆ'],
                surprise: ['ë†€ë¼', 'ê¹œì§', 'ì™€', 'ì–´ë¨¸', 'í—', 'ëŒ€ë°•', 'ì§„ì§œ', 'ì„¸ìƒì—', 'ì–´ë–»ê²Œ', 'ë¯¿ì„ìˆ˜ì—†ì–´'],
                fear: ['ë¬´ì„œ', 'ë‘ë ¤', 'ê±±ì •', 'ë¶ˆì•ˆ', 'ë–¨ë ¤', 'ê²ë‚˜', 'ì¡°ì‹¬', 'ìœ„í—˜', 'ì•„ì´ê³ '],
                neutral: ['ê·¸ëƒ¥', 'ë³´í†µ', 'ë³„ë¡œ', 'ìŒ', 'ê¸€ì„', 'í•˜ì§€ë§Œ', 'ê·¸ëŸ¬ë‚˜', 'ë„¤', 'ì•„ë‹ˆìš”']
            };
            
            let maxScore = 0;
            let detectedEmotion = 'neutral';
            
            // í…ìŠ¤íŠ¸ë¥¼ ì†Œë¬¸ìë¡œ ë³€í™˜í•˜ê³  ê³µë°± ì œê±°
            const normalizedText = text.toLowerCase().replace(/\s/g, '');
            
            for (const [emotion, keywords] of Object.entries(emotionKeywords)) {
                let score = 0;
                keywords.forEach(keyword => {
                    if (normalizedText.includes(keyword)) {
                        score += 2; // ì ìˆ˜ë¥¼ 2ë°°ë¡œ ì¦ê°€
                    }
                    // ë¶€ë¶„ ë§¤ì¹­ë„ í™•ì¸
                    if (text.includes(keyword.substring(0, 2)) && keyword.length > 2) {
                        score += 1;
                    }
                });
                
                if (score > maxScore) {
                    maxScore = score;
                    detectedEmotion = emotion;
                }
            }
            
            const confidence = Math.min(maxScore / 2, 1.0);
            return { emotion: detectedEmotion, confidence: confidence };
        }
        
        function createRealisticAvatar() {
            // 3D ì”¬ ì´ˆê¸°í™”
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, 400 / 500, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            renderer.setSize(400, 500);
            renderer.setClearColor(0x000000, 0);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            
            const avatarContainer = document.getElementById('avatar-container');
            if (avatarContainer) {
                avatarContainer.appendChild(renderer.domElement);
            }
            
            // ì¡°ëª… ì„¤ì •
            const ambientLight = new THREE.AmbientLight(0x404040, 0.4);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 10, 5);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            scene.add(directionalLight);
            
            // í¬ì¸íŠ¸ ë¼ì´íŠ¸ ì¶”ê°€ (ì–¼êµ´ ì¡°ëª…)
            const pointLight = new THREE.PointLight(0xffffff, 0.6, 100);
            pointLight.position.set(0, 3, 3);
            scene.add(pointLight);
            
            // ë¦¬ì–¼ë¦¬ìŠ¤í‹± ì•„ë°”íƒ€ ìƒì„±
            const group = new THREE.Group();
            
            // ğŸ¨ ë¦¬ì–¼ë¦¬ìŠ¤í‹± ë¨¸í‹°ë¦¬ì–¼
            const skinMaterial = new THREE.MeshLambertMaterial({ 
                color: 0xffdbac,
                transparent: true,
                opacity: 0.95
            });
            
            const hairMaterial = new THREE.MeshPhongMaterial({ 
                color: 0x8b4513,
                shininess: 20
            });
            
            const clothMaterial = new THREE.MeshLambertMaterial({ 
                color: 0x3498db
            });
            
            const eyeMaterial = new THREE.MeshPhongMaterial({ 
                color: 0x333333,
                shininess: 100
            });
            
            // ğŸ‘¤ ë¦¬ì–¼ë¦¬ìŠ¤í‹± í—¤ë“œ (ë” ì •êµí•œ í˜•íƒœ)
            const headGroup = new THREE.Group();
            
            // ë©”ì¸ í—¤ë“œ (íƒ€ì›í˜•)
            const headGeometry = new THREE.SphereGeometry(0.5, 32, 32);
            headGeometry.scale(1, 1.1, 0.85);
            const head = new THREE.Mesh(headGeometry, skinMaterial);
            head.castShadow = true;
            head.receiveShadow = true;
            headGroup.add(head);
            
            // ëª©
            const neckGeometry = new THREE.CylinderGeometry(0.25, 0.3, 0.4);
            const neck = new THREE.Mesh(neckGeometry, skinMaterial);
            neck.position.set(0, -0.4, 0);
            neck.castShadow = true;
            headGroup.add(neck);
            
            // ë” ì‚¬ì‹¤ì ì¸ ëˆˆ
            const eyeGeometry = new THREE.SphereGeometry(0.08, 16, 16);
            
            leftEye = new THREE.Mesh(eyeGeometry, eyeMaterial);
            leftEye.position.set(-0.18, 0.1, 0.42);
            headGroup.add(leftEye);
            
            rightEye = new THREE.Mesh(eyeGeometry, eyeMaterial);
            rightEye.position.set(0.18, 0.1, 0.42);
            headGroup.add(rightEye);
            
            // ëˆˆë™ì í•˜ì´ë¼ì´íŠ¸
            const pupilGeometry = new THREE.SphereGeometry(0.02, 8, 8);
            const pupilMaterial = new THREE.MeshBasicMaterial({ color: 0xffffff });
            
            leftPupil = new THREE.Mesh(pupilGeometry, pupilMaterial);
            leftPupil.position.set(-0.16, 0.12, 0.48);
            headGroup.add(leftPupil);
            
            rightPupil = new THREE.Mesh(pupilGeometry, pupilMaterial);
            rightPupil.position.set(0.20, 0.12, 0.48);
            headGroup.add(rightPupil);
            
            // ë¦¬ì–¼ë¦¬ìŠ¤í‹± ì½”
            const noseGeometry = new THREE.ConeGeometry(0.04, 0.12, 8);
            const nose = new THREE.Mesh(noseGeometry, skinMaterial);
            nose.position.set(0, 0, 0.45);
            nose.rotation.x = Math.PI;
            headGroup.add(nose);
            
            // ì…
            const mouthGeometry = new THREE.SphereGeometry(0.06, 16, 8, 0, Math.PI * 2, 0, Math.PI / 2);
            const mouthMaterial = new THREE.MeshLambertMaterial({ color: 0xff6b6b });
            mouth = new THREE.Mesh(mouthGeometry, mouthMaterial);
            mouth.position.set(0, -0.1, 0.44);
            mouth.rotation.x = Math.PI;
            headGroup.add(mouth);
            
            // ë” ìì—°ìŠ¤ëŸ¬ìš´ ë¨¸ë¦¬ì¹´ë½
            const hairGeometry = new THREE.SphereGeometry(0.52, 24, 24);
            hairGeometry.scale(1, 1.2, 0.9);
            const hair = new THREE.Mesh(hairGeometry, hairMaterial);
            hair.position.set(0, 0.2, -0.1);
            hair.castShadow = true;
            headGroup.add(hair);
            
            headGroup.position.set(0, 2.4, 0);
            group.add(headGroup);
            
            // ğŸ«µ ë¦¬ì–¼ë¦¬ìŠ¤í‹± ëª¸í†µ (ë” ìì—°ìŠ¤ëŸ¬ìš´ í˜•íƒœ)
            const torsoGeometry = new THREE.CylinderGeometry(0.35, 0.45, 1.0);
            const torso = new THREE.Mesh(torsoGeometry, clothMaterial);
            torso.position.set(0, 1.5, 0);
            torso.castShadow = true;
            torso.receiveShadow = true;
            group.add(torso);
            
            // ê°€ìŠ´ ë¶€ë¶„ (ë” ìì—°ìŠ¤ëŸ¬ìš´ ì²´í˜•)
            const chestGeometry = new THREE.SphereGeometry(0.4, 16, 16);
            chestGeometry.scale(1, 0.6, 0.8);
            const chest = new THREE.Mesh(chestGeometry, clothMaterial);
            chest.position.set(0, 1.8, 0);
            chest.castShadow = true;
            group.add(chest);
            
            // ğŸ¦¾ ê°„ë‹¨í•˜ê³  ìì—°ìŠ¤ëŸ¬ìš´ íŒ”
            const armGeometry = new THREE.CylinderGeometry(0.07, 0.05, 1.2);
            
            // ì™¼ìª½ íŒ”
            const leftArm = new THREE.Mesh(armGeometry, skinMaterial);
            leftArm.position.set(-0.45, 1.4, 0);
            leftArm.rotation.z = -0.4;
            leftArm.castShadow = true;
            group.add(leftArm);
            
            // ì˜¤ë¥¸ìª½ íŒ”
            const rightArm = new THREE.Mesh(armGeometry, skinMaterial);
            rightArm.position.set(0.45, 1.4, 0);
            rightArm.rotation.z = 0.4;
            rightArm.castShadow = true;
            group.add(rightArm);
            
            // ì†
            const handGeometry = new THREE.SphereGeometry(0.08, 12, 12);
            handGeometry.scale(1.3, 1, 0.8);
            
            const leftHand = new THREE.Mesh(handGeometry, skinMaterial);
            leftHand.position.set(-0.2, 0.8, 0);
            leftHand.castShadow = true;
            group.add(leftHand);
            
            const rightHand = new THREE.Mesh(handGeometry, skinMaterial);
            rightHand.position.set(0.2, 0.8, 0);
            rightHand.castShadow = true;
            group.add(rightHand);
            
            // ğŸ¦µ ë¦¬ì–¼ë¦¬ìŠ¤í‹± ë‹¤ë¦¬
            const pantsMaterial = new THREE.MeshLambertMaterial({ color: 0x2c3e50 });
            
            // í—ˆë¦¬
            const waistGeometry = new THREE.CylinderGeometry(0.4, 0.35, 0.3);
            const waist = new THREE.Mesh(waistGeometry, pantsMaterial);
            waist.position.set(0, 0.85, 0);
            waist.castShadow = true;
            group.add(waist);
            
            // ì™¼ìª½ ë‹¤ë¦¬
            const leftThighGeometry = new THREE.CylinderGeometry(0.12, 0.15, 0.8);
            const leftThigh = new THREE.Mesh(leftThighGeometry, pantsMaterial);
            leftThigh.position.set(-0.15, 0.3, 0);
            leftThigh.castShadow = true;
            group.add(leftThigh);
            
            const leftShinGeometry = new THREE.CylinderGeometry(0.1, 0.12, 0.7);
            const leftShin = new THREE.Mesh(leftShinGeometry, pantsMaterial);
            leftShin.position.set(-0.15, -0.55, 0);
            leftShin.castShadow = true;
            group.add(leftShin);
            
            // ì˜¤ë¥¸ìª½ ë‹¤ë¦¬
            const rightThighGeometry = new THREE.CylinderGeometry(0.12, 0.15, 0.8);
            const rightThigh = new THREE.Mesh(rightThighGeometry, pantsMaterial);
            rightThigh.position.set(0.15, 0.3, 0);
            rightThigh.castShadow = true;
            group.add(rightThigh);
            
            const rightShinGeometry = new THREE.CylinderGeometry(0.1, 0.12, 0.7);
            const rightShin = new THREE.Mesh(rightShinGeometry, pantsMaterial);
            rightShin.position.set(0.15, -0.55, 0);
            rightShin.castShadow = true;
            group.add(rightShin);
            
            // ğŸ‘Ÿ ì‹ ë°œ
            const shoeGeometry = new THREE.BoxGeometry(0.15, 0.08, 0.3);
            const shoeMaterial = new THREE.MeshLambertMaterial({ color: 0x2c3e50 });
            
            const leftShoe = new THREE.Mesh(shoeGeometry, shoeMaterial);
            leftShoe.position.set(-0.15, -0.95, 0.1);
            leftShoe.castShadow = true;
            group.add(leftShoe);
            
            const rightShoe = new THREE.Mesh(shoeGeometry, shoeMaterial);
            rightShoe.position.set(0.15, -0.95, 0.1);
            rightShoe.castShadow = true;
            group.add(rightShoe);
            
            // ì•„ë°”íƒ€ ê·¸ë£¹ì„ sceneì— ì¶”ê°€
            avatar = group;
            scene.add(avatar);
            
            // ì¹´ë©”ë¼ ìœ„ì¹˜ ì„¤ì • (ì•„ë°”íƒ€ê°€ ì˜ ë³´ì´ë„ë¡)
            camera.position.set(0, 1.5, 4);
            camera.lookAt(0, 1.5, 0);
            
            // ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
            animate();
            isAvatarInitialized = true;
            
            console.log('ğŸ¯ ë¦¬ì–¼ë¦¬ìŠ¤í‹± 3D ì•„ë°”íƒ€ ì´ˆê¸°í™” ì™„ë£Œ');
        }
        
        function animate() {
            requestAnimationFrame(animate);
            
            if (avatar) {
                // ê¸°ë³¸ í˜¸í¡ ì• ë‹ˆë©”ì´ì…˜
                avatar.position.y = Math.sin(Date.now() * 0.002) * 0.05;
                
                // ê°ì •ì— ë”°ë¥¸ ê³ ê¸‰ ì• ë‹ˆë©”ì´ì…˜
                switch(currentEmotion) {
                    case 'happy':
                        // ì¦ê±°ìš´ ì¢Œìš° í”ë“¤ë¦¼ + ì í”„
                        avatar.rotation.z = Math.sin(Date.now() * 0.008) * 0.15;
                        avatar.position.y += Math.sin(Date.now() * 0.01) * 0.1;
                        break;
                        
                    case 'sad':
                        // ìŠ¬í”ˆ ê³ ê°œ ìˆ™ì„ + ëŠë¦° ì›€ì§ì„
                        avatar.rotation.x = -0.3 + Math.sin(Date.now() * 0.002) * 0.05;
                        avatar.position.y -= 0.1;
                        break;
                        
                    case 'angry':
                        // í™”ë‚œ ì¢Œìš° ê²©ë ¬í•œ í”ë“¤ë¦¼ + ë–¨ë¦¼
                        avatar.rotation.y = Math.sin(Date.now() * 0.02) * 0.3;
                        avatar.rotation.z = Math.sin(Date.now() * 0.025) * 0.1;
                        break;
                        
                    case 'excited':
                        // í¥ë¶„í•œ í¬ê¸° ë³€í™” + ë¹ ë¥¸ íšŒì „
                        avatar.scale.setScalar(1 + Math.sin(Date.now() * 0.015) * 0.15);
                        avatar.rotation.y = Math.sin(Date.now() * 0.01) * 0.2;
                        break;
                        
                    case 'thinking':
                        // ìƒê°í•˜ëŠ” ì²œì²œíˆ ê³ ê°œ ë„ë•ì„ + ì¢Œìš° ì‚´í´ë³´ê¸°
                        avatar.rotation.x = Math.sin(Date.now() * 0.003) * 0.1;
                        avatar.rotation.y = Math.sin(Date.now() * 0.002) * 0.2;
                        break;
                        
                    case 'surprise':
                        // ë†€ë€ ê°‘ì‘ìŠ¤ëŸ¬ìš´ ë’¤ë¡œ ì –í˜ + í¬ê¸° ë³€í™”
                        avatar.rotation.x = 0.2 + Math.sin(Date.now() * 0.02) * 0.1;
                        avatar.scale.setScalar(1 + Math.sin(Date.now() * 0.03) * 0.2);
                        break;
                        
                    case 'fear':
                        // ë‘ë ¤ìš´ ë–¨ë¦¼ + ì›€ì¸ ëŸ¬ë“¦
                        avatar.rotation.x = Math.sin(Date.now() * 0.05) * 0.05;
                        avatar.rotation.z = Math.sin(Date.now() * 0.07) * 0.05;
                        avatar.scale.setScalar(0.95 + Math.sin(Date.now() * 0.04) * 0.05);
                        break;
                        
                    case 'neutral':
                    default:
                        // ê¸°ë³¸ ìƒíƒœë¡œ ë¶€ë“œëŸ½ê²Œ ë³µê·€
                        avatar.rotation.x = avatar.rotation.x * 0.95;
                        avatar.rotation.y = avatar.rotation.y * 0.95;
                        avatar.rotation.z = avatar.rotation.z * 0.95;
                        avatar.scale.setScalar(avatar.scale.x * 0.99 + 0.01);
                        break;
                }
                
                // ì˜· ìƒ‰ìƒ ë³€ê²½ (ê°ì •ì— ë”°ë¼)
                if (avatar.children && avatar.children.length > 0) {
                    updateAvatarColors(currentEmotion);
                }
            }
            
            if (renderer) {
                renderer.render(scene, camera);
            }
        }
        
        function updateAvatarColors(emotion) {
            // ê°ì •ë³„ ìƒ‰ìƒ ì„¤ì •
            const emotionColors = {
                'happy': { cloth: 0x3498db, intensity: 1.2 },      // ë°ì€ íŒŒë‘
                'sad': { cloth: 0x7f8c8d, intensity: 0.6 },        // íšŒìƒ‰
                'angry': { cloth: 0xe74c3c, intensity: 1.5 },      // ë¹¨ê°•
                'excited': { cloth: 0xf39c12, intensity: 1.4 },    // ì£¼í™©
                'thinking': { cloth: 0x9b59b6, intensity: 1.0 },   // ë³´ë¼
                'surprise': { cloth: 0xf1c40f, intensity: 1.3 },   // ë…¸ë‘
                'fear': { cloth: 0x34495e, intensity: 0.7 },       // ì–´ë‘ìš´ íšŒìƒ‰
                'neutral': { cloth: 0x3498db, intensity: 1.0 }     // ê¸°ë³¸ íŒŒë‘
            };
            
            const config = emotionColors[emotion] || emotionColors.neutral;
            
            // ì˜· ìƒ‰ìƒ ë³€ê²½ (torso, chest ì°¾ì•„ì„œ ë³€ê²½)
            avatar.traverse(function(child) {
                if (child.isMesh && child.material) {
                    if (child.material.color && 
                        (child.material.color.getHex() === 0x3498db || 
                         child.material.color.getHex() === 0xe74c3c || 
                         child.material.color.getHex() === 0xf39c12 ||
                         child.material.color.getHex() === 0x7f8c8d ||
                         child.material.color.getHex() === 0x9b59b6 ||
                         child.material.color.getHex() === 0xf1c40f ||
                         child.material.color.getHex() === 0x34495e)) {
                        child.material.color.setHex(config.cloth);
                    }
                }
            });
        }
        
        function updateFacialExpression(emotion) {
            if (!leftEye || !rightEye || !mouth) return;
            
            // ê°ì •ë³„ í‘œì • ì„¤ì •
            switch(emotion) {
                case 'happy':
                    // ì›ƒëŠ” í‘œì •: ëˆˆ ì‘ì•„ì§€ê³  ì… ìœ„ë¡œ
                    leftEye.scale.set(1, 0.6, 1);
                    rightEye.scale.set(1, 0.6, 1);
                    mouth.position.y = -0.05;
                    mouth.scale.set(1.3, 0.8, 1);
                    mouth.material.color.setHex(0xff8a95);
                    break;
                    
                case 'sad':
                    // ìŠ¬í”ˆ í‘œì •: ëˆˆ ì²˜ì§€ê³  ì… ì•„ë˜ë¡œ
                    leftEye.scale.set(1, 1.2, 1);
                    rightEye.scale.set(1, 1.2, 1);
                    leftEye.rotation.z = 0.2;
                    rightEye.rotation.z = -0.2;
                    mouth.position.y = -0.15;
                    mouth.scale.set(0.8, 1.2, 1);
                    mouth.material.color.setHex(0x8b7d7d);
                    break;
                    
                case 'angry':
                    // í™”ë‚œ í‘œì •: ëˆˆ ì°¡ê·¸ë¦¬ê³  ì… ì¼ê·¸ëŸ¬ì§
                    leftEye.scale.set(0.8, 1.3, 1);
                    rightEye.scale.set(0.8, 1.3, 1);
                    leftEye.rotation.z = -0.3;
                    rightEye.rotation.z = 0.3;
                    mouth.position.y = -0.12;
                    mouth.scale.set(0.6, 1.5, 1);
                    mouth.material.color.setHex(0xcc4444);
                    break;
                    
                case 'excited':
                    // í¥ë¶„í•œ í‘œì •: ëˆˆ í¬ê³  ì… ë²Œì–´ì§
                    leftEye.scale.set(1.4, 1.4, 1.4);
                    rightEye.scale.set(1.4, 1.4, 1.4);
                    mouth.position.y = -0.08;
                    mouth.scale.set(1.6, 1.6, 1.6);
                    mouth.material.color.setHex(0xff5566);
                    break;
                    
                case 'thinking':
                    // ìƒê°í•˜ëŠ” í‘œì •: í•œìª½ ëˆˆ ì°¡ê·¸ë¦¼
                    leftEye.scale.set(0.7, 1, 1);
                    rightEye.scale.set(1.2, 1, 1);
                    mouth.position.y = -0.1;
                    mouth.scale.set(0.9, 0.9, 1);
                    mouth.material.color.setHex(0xaa6666);
                    break;
                    
                case 'surprise':
                    // ë†€ë€ í‘œì •: ëˆˆê³¼ ì… í¬ê²Œ ë²Œì–´ì§
                    leftEye.scale.set(1.6, 1.8, 1.6);
                    rightEye.scale.set(1.6, 1.8, 1.6);
                    mouth.position.y = -0.05;
                    mouth.scale.set(1.8, 2.0, 1.8);
                    mouth.material.color.setHex(0xff4455);
                    break;
                    
                case 'fear':
                    // ë‘ë ¤ìš´ í‘œì •: ëˆˆ í¬ê³  ì… ì‘ì•„ì§
                    leftEye.scale.set(1.3, 1.5, 1.3);
                    rightEye.scale.set(1.3, 1.5, 1.3);
                    mouth.position.y = -0.13;
                    mouth.scale.set(0.5, 0.8, 1);
                    mouth.material.color.setHex(0x996666);
                    break;
                    
                case 'neutral':
                default:
                    // ê¸°ë³¸ í‘œì •ìœ¼ë¡œ ë³µì›
                    leftEye.scale.set(1, 1, 1);
                    rightEye.scale.set(1, 1, 1);
                    leftEye.rotation.z = 0;
                    rightEye.rotation.z = 0;
                    mouth.position.y = -0.1;
                    mouth.scale.set(1, 1, 1);
                    mouth.material.color.setHex(0xff6b6b);
                    break;
            }
        }
        
        function updateAvatarEmotion(emotion) {
            currentEmotion = emotion;
            
            console.log(`ğŸ­ ì•„ë°”íƒ€ ê°ì • ë³€ê²½: ${emotion}`);
            
            // ì¦‰ì‹œ ìƒ‰ìƒ ë³€ê²½
            if (avatar) {
                updateAvatarColors(emotion);
            }
            
            // í‘œì • ë³€í™” ì ìš©
            updateFacialExpression(emotion);
            
            // ê°ì • í‘œì‹œ ì—…ë°ì´íŠ¸
            const emotionDisplay = document.getElementById('current-emotion');
            if (emotionDisplay) {
                emotionDisplay.textContent = getEmotionKorean(emotion);
            }
            
            // ê°ì • í†µê³„ ì—…ë°ì´íŠ¸
            updateEmotionStats(emotion);
        }
        
        function getEmotionKorean(emotion) {
            const emotionMap = {
                'happy': 'ğŸ˜Š ê¸°ì¨',
                'sad': 'ğŸ˜¢ ìŠ¬í””',
                'angry': 'ğŸ˜  í™”ë‚¨',
                'excited': 'ğŸ¤© í¥ë¶„',
                'thinking': 'ğŸ¤” ìƒê°',
                'surprise': 'ğŸ˜® ë†€ëŒ',
                'fear': 'ğŸ˜¨ ë‘ë ¤ì›€',
                'neutral': 'ğŸ˜ í‰ì˜¨'
            };
            return emotionMap[emotion] || 'ğŸ˜ í‰ì˜¨';
        }
        
        function updateEmotionStats(emotion) {
            const statsElement = document.getElementById('emotion-stats');
            if (!statsElement) return;
            
            // ê°„ë‹¨í•œ í†µê³„ ì—…ë°ì´íŠ¸ (ì‹¤ì œë¡œëŠ” ì„œë²„ì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ì•¼ í•¨)
            const stats = {
                'happy': Math.floor(Math.random() * 50) + 20,
                'sad': Math.floor(Math.random() * 30) + 10,
                'angry': Math.floor(Math.random() * 20) + 5,
                'surprise': Math.floor(Math.random() * 25) + 10,
                'fear': Math.floor(Math.random() * 15) + 5,
                'neutral': Math.floor(Math.random() * 40) + 30
            };
            
            let statsHtml = '';
            for (const [key, value] of Object.entries(stats)) {
                const korean = getEmotionKorean(key);
                statsHtml += `<div class="stat-item">
                    <span>${korean}</span>
                    <span>${value}%</span>
                </div>`;
            }
            
            statsElement.innerHTML = statsHtml;
        }
        
        // ì•„ë°”íƒ€ ì±„íŒ… ê¸°ëŠ¥
        function sendAvatarMessage() {
            const input = document.getElementById('avatar-chat-input');
            const messages = document.getElementById('avatar-messages');
            
            if (!input || !messages) return;
            
            const message = input.value.trim();
            if (!message) return;
            
            // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
            const userMessage = document.createElement('div');
            userMessage.className = 'message user-message';
            userMessage.textContent = message;
            messages.appendChild(userMessage);
            
            // ê°ì • ë¶„ì„
            const emotionResult = analyzeKoreanEmotion(message);
            updateAvatarEmotion(emotionResult.emotion);
            
            // íŠ¹ë³„í•œ ì§ˆë¬¸ íŒ¨í„´ ê°ì§€
            const specialQuestions = {
                'ë„ê¹¨ë¹„': [
                    'ğŸ§šâ€â™‚ï¸ ì•„í•˜! ë„ê¹¨ë¹„ë“¤ê³¼ ë¹„êµí•˜ì‹œëŠ”êµ°ìš”!\n\n' +
                    'ğŸ‘¥ **ì „ë¬¸ê°€ ë„ê¹¨ë¹„ë“¤ì˜ íŠ¹ì§•:**\n' +
                    'â€¢ ê°ê° ì „ë¬¸ ë¶„ì•¼ì˜ ê¹Šì€ ì§€ì‹ ë³´ìœ \n' +
                    'â€¢ 16ëª…ì´ í˜‘ì—…í•´ì„œ ì¢…í•©ì  ë‹µë³€ ì œê³µ\n' +
                    'â€¢ ì‹¤ë¬´ ê²½í—˜ ê¸°ë°˜ì˜ ì‹¤ìš©ì  ì¡°ì–¸\n\n' +
                    'ğŸ¤– **ì € (3D ì•„ë°”íƒ€)ì˜ íŠ¹ì§•:**\n' +
                    'â€¢ ì‹¤ì‹œê°„ ê°ì • ì¸ì‹ ë° í‘œí˜„\n' +
                    'â€¢ ì‹œê°ì  í”¼ë“œë°±ìœ¼ë¡œ ë” ì¹œê·¼í•œ ì†Œí†µ\n' +
                    'â€¢ ê°ì • ìƒíƒœì— ë”°ë¥¸ ë§ì¶¤ ì‘ë‹µ\n\n' +
                    'ğŸ¯ **ê²°ë¡ :** ë„ê¹¨ë¹„ë“¤ì´ ì „ë¬¸ ì§€ì‹ì„, ì œê°€ ê°ì •ì  êµê°ì„ ë‹´ë‹¹í•´ìš”! ì™„ë²½í•œ ì¡°í•©ì´ì£ ! ğŸ˜Š',
                    
                    'ğŸ˜„ ë„ê¹¨ë¹„ë“¤ VS ì €ì˜ ëŒ€ê²°ì´ë„¤ìš”!\n\n' +
                    'ğŸ† **ë„ê¹¨ë¹„ë“¤ì˜ ê°•ì :**\n' +
                    'â€¢ ì¸ê³µì§€ëŠ¥ë°•ì‚¬, ì˜í•™ë°•ì‚¬, ê²½ì˜í•™ë°•ì‚¬ ë“± ì „ë¬¸ì„± ëíŒì™•\n' +
                    'â€¢ 1000ì ê³ ê¸‰ ë¶„ì„ìœ¼ë¡œ ê¹Šì´ ìˆëŠ” ë‹µë³€\n' +
                    'â€¢ ì‹¤ì œ ì—…ê³„ ê²½í—˜ ë°”íƒ•ì˜ ì‹¤ë¬´ íŒ\n\n' +
                    'ğŸ’– **ì œ ê°•ì :**\n' +
                    'â€¢ í‘œì • ë³€í™”ë¡œ ê°ì • í‘œí˜„ (ë„ê¹¨ë¹„ë“¤ì€ í…ìŠ¤íŠ¸ë§Œ!)\n' +
                    'â€¢ ì‹¤ì‹œê°„ ë°˜ì‘ìœ¼ë¡œ ì¦‰ê°ì  ì†Œí†µ\n' +
                    'â€¢ 3D ë¹„ì£¼ì–¼ë¡œ ë” ìƒìƒí•œ ìƒí˜¸ì‘ìš©\n\n' +
                    'ğŸ¤ **ìµœì¢… ê²°ë¡ :** ë„ê¹¨ë¹„ë“¤ì´ ë¨¸ë¦¬, ì œê°€ ë§ˆìŒì„ ë‹´ë‹¹í•˜ëŠ” ë“œë¦¼íŒ€ì´ì—ìš”!',
                    
                    'ğŸ­ ì¬ë¯¸ìˆëŠ” ë¹„êµë„¤ìš”!\n\n' +
                    'ğŸ‘‘ **ë„ê¹¨ë¹„ ì „ë¬¸ê°€ë“¤:**\n' +
                    'â€¢ ê°ì 20ë…„+ ê²½ë ¥ì˜ ë² í…Œë‘\n' +
                    'â€¢ ë…¼ë¦¬ì ì´ê³  ì²´ê³„ì ì¸ ë¶„ì„ ì œê³µ\n' +
                    'â€¢ ì „ë¬¸ ìš©ì–´ì™€ ìƒì„¸í•œ ì„¤ëª… íŠ¹í™”\n\n' +
                    'ğŸŒŸ **3D ì•„ë°”íƒ€ ì €:**\n' +
                    'â€¢ ê°ì •ì„ ì½ê³  ê³µê°í•˜ëŠ” ëŠ¥ë ¥\n' +
                    'â€¢ ì¹œê·¼í•˜ê³  ì ‘ê·¼í•˜ê¸° ì‰¬ìš´ ëŒ€í™”\n' +
                    'â€¢ ì‹œê°ì  ì¬ë¯¸ì™€ ê°ì •ì  ìœ„ë¡œ ì œê³µ\n\n' +
                    'âœ¨ **ê¶ê·¹ì˜ ì¡°í•©:** ë„ê¹¨ë¹„ë“¤ì—ê²Œ ì „ë¬¸ ìƒë‹´ì„, ì €ì—ê²ŒëŠ” ê°ì •ì  íë§ì„ ë°›ìœ¼ì„¸ìš”! ğŸ˜Š'
                ]
            };
            
            // íŠ¹ë³„ ì‘ë‹µ í™•ì¸
            let specialResponse = null;
            for (const [keyword, responses] of Object.entries(specialQuestions)) {
                if (message.includes(keyword)) {
                    specialResponse = responses[Math.floor(Math.random() * responses.length)];
                    break;
                }
            }
            
            // ê°ì •ë³„ ë§ì¶¤ ì‘ë‹µ
            const emotionResponses = {
                'happy': [
                    'ì •ë§ ê¸°ì˜ì‹œê² ì–´ìš”! ğŸ˜Š\nì €ë„ ë©ë‹¬ì•„ ê¸°ë¶„ì´ ì¢‹ì•„ì ¸ìš”!',
                    'ì™€! í–‰ë³µí•œ ê¸°ë¶„ì´ ì „í•´ì ¸ìš”! ğŸ‰\nì¢‹ì€ í•˜ë£¨ ë³´ë‚´ì„¸ìš”!',
                    'ì¢‹ì€ ì¼ì´ ìˆìœ¼ì…¨ë‚˜ë´ìš”!\nì¶•í•˜ë“œë ¤ìš”! âœ¨'
                ],
                'sad': [
                    'í˜ë“  ì‹œê°„ì´ì‹œêµ°ìš”... ğŸ˜¢\nê´œì°®ì•„ì§ˆ ê±°ì˜ˆìš”.\nì œê°€ ê³ì— ìˆì„ê²Œìš”.',
                    'ìŠ¬í”„ì‹œê² ì–´ìš”.\nëª¨ë“  ê²Œ ë‹¤ ì§€ë‚˜ê°ˆ ê±°ì˜ˆìš”.\ní˜ë‚´ì„¸ìš”! ğŸ’™',
                    'ì–´ë ¤ìš´ ìƒí™©ì´ì‹œêµ°ìš”.\nì²œì²œíˆ ì´ê²¨ë‚´ë´ìš”.\nì‘ì›í• ê²Œìš”! ğŸ¤—'
                ],
                'angry': [
                    'í™”ê°€ ë§ì´ ë‚˜ì…¨ë‚˜ë´ìš” ğŸ˜ \nì ì‹œ ì‹¬í˜¸í¡í•´ë³´ì„¸ìš”.\nì§„ì •í•˜ì‹œë©´ ë” ì¢‹ì€ í•´ê²°ì±…ì´ ë³´ì¼ ê±°ì˜ˆìš”.',
                    'ìŠ¤íŠ¸ë ˆìŠ¤ ë°›ìœ¼ì…¨êµ°ìš”.\nì¡°ê¸ˆ ì§„ì •í•´ë³´ì‹¤ê¹Œìš”?\nì´ì•¼ê¸°í•˜ë©´ ì‹œì›í•´ì§ˆ ê±°ì˜ˆìš”.',
                    'í˜ë“  ìƒí™©ì´ì‹œê² ë„¤ìš”.\ní™”ë‚´ì‹¤ ë§Œí•˜êµ°ìš”.\nì œê°€ ë“¤ì–´ë“œë¦´ê²Œìš”.'
                ],
                'excited': [
                    'ì™€! ì •ë§ ì‹ ë‚˜ì‹œëŠ”êµ°ìš”! ğŸ¤©\nì €ë„ ê¸°ëŒ€ë¼ìš”!\në” ìì„¸íˆ ë“¤ë ¤ì£¼ì„¸ìš”!',
                    'í¥ë¯¸ì§„ì§„í•˜ë„¤ìš”!\nì—ë„ˆì§€ê°€ ë„˜ì¹˜ì‹œë„¤ìš”!\në©‹ì ¸ìš”! âš¡',
                    'ì •ë§ ì‹ ì´ ë‚˜ì…¨ë‚˜ë´ìš”!\nì €ë„ ë©ë‹¬ì•„ ì‹ ë‚˜ìš”!\nê³„ì† ë§ì”€í•´ì£¼ì„¸ìš”! ğŸ‰'
                ],
                'thinking': [
                    'ê¹Šì´ ìƒê°í•˜ê³  ê³„ì‹œëŠ”êµ°ìš” ğŸ¤”\nì²œì²œíˆ ìƒê°í•´ë³´ì„¸ìš”.\nì¢‹ì€ ì•„ì´ë””ì–´ê°€ ë– ì˜¤ë¥¼ ê±°ì˜ˆìš”.',
                    'ê³ ë¯¼ì´ ìˆìœ¼ì‹œêµ°ìš”.\ní•¨ê»˜ ìƒê°í•´ë³¼ê¹Œìš”?\në‘ ëª…ì´ ìƒê°í•˜ë©´ ë” ì¢‹ì€ ë‹µì´ ë‚˜ì˜¬ ê±°ì˜ˆìš”.',
                    'ì–´ë ¤ìš´ ë¬¸ì œì¸ê°€ë´ìš”.\nê³ ë¯¼ì„ ë‚˜ëˆ„ì‹œë©´\ní•´ê²°ì±…ì´ ë³´ì¼ ê±°ì˜ˆìš”.'
                ],
                'surprise': [
                    'ì •ë§ ë†€ë¼ìš°ì…¨ê² ì–´ìš”! ğŸ˜®\nì–´ë–¤ ì¼ì¸ì§€ ê¶ê¸ˆí•´ìš”!\në” ìì„¸íˆ ë§ì”€í•´ì£¼ì„¸ìš”!',
                    'ê¹œì§ ë†€ë¼ì…¨êµ°ìš”!\nëŒ€ë‹¨í•œ ì¼ì´ ìˆì—ˆë‚˜ë´ìš”!\nì™€! ë¯¿ì„ ìˆ˜ ì—†ì–´ìš”! ğŸŒŸ',
                    'ì •ë§ ì˜ˆìƒì¹˜ ëª»í•œ ì¼ì´ì…¨ë‚˜ë´ìš”!\në†€ë¼ì›€ì´ ì „í•´ì ¸ìš”!\nì–´ë–¤ ì¼ì¸ì§€ ë“¤ë ¤ì£¼ì„¸ìš”!'
                ],
                'fear': [
                    'ë¬´ì„œìš°ì…¨ê² ì–´ìš” ğŸ˜¨\nê´œì°®ì•„ìš”, ì•ˆì „í•  ê±°ì˜ˆìš”.\nì œê°€ í•¨ê»˜ ìˆì„ê²Œìš”.',
                    'ê±±ì •ì´ ë§ìœ¼ì‹œêµ°ìš”.\nì°¨ê·¼ì°¨ê·¼ í•´ê²°í•´ë´ìš”.\nëª¨ë“  ê²Œ ì˜ ë  ê±°ì˜ˆìš”.',
                    'ë¶ˆì•ˆí•˜ì‹œê² ì§€ë§Œ\në„ˆë¬´ ê±±ì •í•˜ì§€ ë§ˆì„¸ìš”.\ní•¨ê»˜ ì´ê²¨ë‚´ë´ìš”! ğŸ¤—'
                ],
                'neutral': [
                    'ë§ì”€í•´ì£¼ì„¸ìš”.\nì–´ë–»ê²Œ ë„ì™€ë“œë¦´ê¹Œìš”? ğŸ˜Š\nê¶ê¸ˆí•œ ê²ƒì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ë¬¼ì–´ë³´ì„¸ìš”!',
                    'ë„¤, ì˜ ë“¤ì—ˆì–´ìš”.\në” ì´ì•¼ê¸°í•´ì£¼ì„¸ìš”.\ní¸í•˜ê²Œ ë§ì”€í•˜ì„¸ìš”.',
                    'ê·¸ë ‡êµ°ìš”.\në” ê¶ê¸ˆí•œ ê²ƒì´ ìˆìœ¼ì‹œë©´\nì–¸ì œë“  ë§ì”€í•´ì£¼ì„¸ìš”!'
                ]
            };
            
            // ì•„ë°”íƒ€ ì‘ë‹µ
            setTimeout(() => {
                let finalResponse;
                
                if (specialResponse) {
                    finalResponse = specialResponse;
                } else {
                    const responses = emotionResponses[emotionResult.emotion] || emotionResponses['neutral'];
                    finalResponse = responses[Math.floor(Math.random() * responses.length)];
                }
                
                const avatarMessage = document.createElement('div');
                avatarMessage.className = 'message avatar-message';
                avatarMessage.textContent = finalResponse;
                messages.appendChild(avatarMessage);
                
                // ìŠ¤í¬ë¡¤ í•˜ë‹¨ìœ¼ë¡œ
                messages.scrollTop = messages.scrollHeight;
                
                console.log(`ğŸ­ ê°ì • ë¶„ì„: ${emotionResult.emotion} (ì‹ ë¢°ë„: ${emotionResult.confidence.toFixed(2)})`);
            }, 800);
            
            input.value = '';
            messages.scrollTop = messages.scrollHeight;
        }
        
        // ì—”í„°í‚¤ë¡œ ë©”ì‹œì§€ ì „ì†¡
        function handleAvatarKeyPress(event) {
            if (event.key === 'Enter') {
                sendAvatarMessage();
            }
        }
        
        // ê°ì • ë²„íŠ¼ í´ë¦­ í•¸ë“¤ëŸ¬
        function setAvatarEmotion(emotion) {
            updateAvatarEmotion(emotion);
        }

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            initSocket();
            loadGoblins();
            
            // 3D ì•„ë°”íƒ€ ì´ˆê¸°í™”
            setTimeout(() => {
                if (document.getElementById('avatar-container')) {
                    createRealisticAvatar();
                    updateEmotionStats('neutral');
                }
            }, 1000);
            
            // ì£¼ê¸°ì ìœ¼ë¡œ ì„±ëŠ¥ ë°ì´í„° ìš”ì²­
            setInterval(async () => {
                try {
                    const response = await fetch('/api/performance');
                    const data = await response.json();
                    if (data.status === 'success') {
                        updatePerformanceStats({
                            performance: data.data,
                            active_users: data.data.active_users
                        });
                    }
                } catch (error) {
                    console.error('ì„±ëŠ¥ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                }
            }, 30000); // 30ì´ˆë§ˆë‹¤
        });
    </script>
</body>
</html>
