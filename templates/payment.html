<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ’³ ë„ê¹¨ë¹„ë§ˆì„ì¥í„° ê²°ì œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem;
        }

        .payment-container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .header h1 {
            color: #5a67d8;
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .payment-form {
            display: grid;
            gap: 1.5rem;
        }

        .form-group {
            display: grid;
            gap: 0.5rem;
        }

        label {
            font-weight: 600;
            color: #333;
        }

        select, input {
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #5a67d8;
        }

        .expert-card {
            background: #f7fafc;
            padding: 1rem;
            border-radius: 10px;
            border: 2px solid #e2e8f0;
            margin-bottom: 1rem;
        }

        .expert-card.selected {
            border-color: #5a67d8;
            background: #ebf4ff;
        }

        .price-info {
            background: #f0fff4;
            padding: 1rem;
            border-radius: 10px;
            border: 2px solid #68d391;
            text-align: center;
        }

        .payment-methods {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .payment-method {
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .payment-method:hover {
            border-color: #5a67d8;
            background: #ebf4ff;
        }

        .payment-method.selected {
            border-color: #5a67d8;
            background: #ebf4ff;
        }

        .pay-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            border: none;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .pay-button:hover {
            transform: translateY(-2px);
        }

        .loading {
            display: none;
            text-align: center;
            color: #5a67d8;
        }
    </style>
</head>
<body>
    <div class="payment-container">
        <div class="header">
            <h1>ğŸ’³ ë„ê¹¨ë¹„ë§ˆì„ì¥í„° ê²°ì œ</h1>
            <p>ì „ë¬¸ê°€ ë„ê¹¨ë¹„ ìƒë‹´ ì„œë¹„ìŠ¤</p>
        </div>

        <div class="payment-form">
            <div class="form-group">
                <label for="expert-select">ìƒë‹´ ë°›ì„ ì „ë¬¸ê°€ ì„ íƒ</label>
                <select id="expert-select">
                    <option value="">ì „ë¬¸ê°€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</option>
                </select>
            </div>

            <div class="form-group">
                <label>ìƒë‹´ ì‹œê°„</label>
                <div class="payment-methods">
                    <div class="payment-method" data-time="30" data-price="1">
                        <div>â° 30ë¶„</div>
                        <div>ê¸°ë³¸ ìƒë‹´</div>
                    </div>
                    <div class="payment-method" data-time="60" data-price="1.8">
                        <div>â° 60ë¶„</div>
                        <div>ì‹¬í™” ìƒë‹´</div>
                    </div>
                    <div class="payment-method" data-time="90" data-price="2.5">
                        <div>â° 90ë¶„</div>
                        <div>ì§‘ì¤‘ ìƒë‹´</div>
                    </div>
                </div>
            </div>

            <div class="price-info">
                <div>ğŸ’° ê²°ì œ ê¸ˆì•¡</div>
                <div id="total-price" style="font-size: 1.5rem; font-weight: bold; color: #38a169;">0ì›</div>
            </div>

            <div class="form-group">
                <label>ê²°ì œ ë°©ë²•</label>
                <div class="payment-methods">
                    <div class="payment-method" data-method="kakao">
                        <div>ğŸ’› ì¹´ì¹´ì˜¤í˜ì´</div>
                    </div>
                    <div class="payment-method" data-method="toss">
                        <div>ğŸ’™ í† ìŠ¤í˜ì´</div>
                    </div>
                    <div class="payment-method" data-method="card">
                        <div>ğŸ’³ ì‹ ìš©ì¹´ë“œ</div>
                    </div>
                    <div class="payment-method" data-method="bank">
                        <div>ğŸ¦ ê³„ì¢Œì´ì²´</div>
                    </div>
                </div>
            </div>

            <button class="pay-button" onclick="processPayment()">ê²°ì œí•˜ê¸°</button>
            
            <div class="loading">
                <div>ê²°ì œ ì²˜ë¦¬ ì¤‘...</div>
            </div>
        </div>
    </div>

    <script>
        let selectedExpert = null;
        let selectedTime = null;
        let selectedMethod = null;
        let basePrice = 0;

        // ì „ë¬¸ê°€ ëª©ë¡ ë¡œë“œ
        fetch('/api/experts')
            .then(response => response.json())
            .then(experts => {
                const select = document.getElementById('expert-select');
                experts.forEach(expert => {
                    const option = document.createElement('option');
                    option.value = expert.id;
                    option.textContent = `${expert.name} (${expert.category}) - ${expert.price.toLocaleString()}ì›`;
                    option.dataset.price = expert.price;
                    option.dataset.name = expert.name;
                    select.appendChild(option);
                });
            });

        // ì „ë¬¸ê°€ ì„ íƒ
        document.getElementById('expert-select').addEventListener('change', function() {
            const option = this.options[this.selectedIndex];
            if (option.value) {
                selectedExpert = {
                    id: option.value,
                    name: option.dataset.name,
                    price: parseInt(option.dataset.price)
                };
                basePrice = selectedExpert.price;
                updatePrice();
            }
        });

        // ìƒë‹´ ì‹œê°„ ì„ íƒ
        document.querySelectorAll('[data-time]').forEach(method => {
            method.addEventListener('click', function() {
                document.querySelectorAll('[data-time]').forEach(m => m.classList.remove('selected'));
                this.classList.add('selected');
                selectedTime = {
                    minutes: this.dataset.time,
                    multiplier: parseFloat(this.dataset.price)
                };
                updatePrice();
            });
        });

        // ê²°ì œ ë°©ë²• ì„ íƒ
        document.querySelectorAll('[data-method]').forEach(method => {
            method.addEventListener('click', function() {
                document.querySelectorAll('[data-method]').forEach(m => m.classList.remove('selected'));
                this.classList.add('selected');
                selectedMethod = this.dataset.method;
            });
        });

        // ê°€ê²© ì—…ë°ì´íŠ¸
        function updatePrice() {
            if (selectedExpert && selectedTime) {
                const totalPrice = Math.round(basePrice * selectedTime.multiplier);
                document.getElementById('total-price').textContent = totalPrice.toLocaleString() + 'ì›';
            }
        }

        // ê²°ì œ ì²˜ë¦¬
        function processPayment() {
            if (!selectedExpert || !selectedTime || !selectedMethod) {
                alert('ëª¨ë“  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const totalPrice = Math.round(basePrice * selectedTime.multiplier);

            // ë¡œë”© í‘œì‹œ
            document.querySelector('.loading').style.display = 'block';
            document.querySelector('.pay-button').style.display = 'none';

            // ê²°ì œ API í˜¸ì¶œ
            fetch('/api/payment/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    expert_name: selectedExpert.name,
                    service_type: `${selectedTime.minutes}ë¶„ ìƒë‹´`,
                    amount: totalPrice,
                    payment_method: selectedMethod
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert(`ê²°ì œ ìš”ì²­ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!\nê²°ì œ ID: ${data.payment_id}`);
                    // ì‹¤ì œë¡œëŠ” PGì‚¬ ê²°ì œ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
                    window.location.href = '/';
                } else {
                    alert('ê²°ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ê²°ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            })
            .finally(() => {
                document.querySelector('.loading').style.display = 'none';
                document.querySelector('.pay-button').style.display = 'block';
            });
        }
    </script>
</body>
</html>
