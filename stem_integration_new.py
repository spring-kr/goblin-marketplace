"""
ğŸ¯ AI ë„ê¹¨ë¹„ë§ˆì„ STEM ì„¼í„° - ì‹¤ì œ AI ëŒ€í™” ì‹œìŠ¤í…œ
ì§„ì§œ AIì²˜ëŸ¼ ìì—°ìŠ¤ëŸ½ê³  ë§¥ë½ì ì¸ ì‘ë‹µì„ ì œê³µí•˜ëŠ” 16ê°œ ë„ê¹¨ë¹„ ì‹œìŠ¤í…œ
"""

import random
from datetime import datetime
from typing import Dict, Any, Optional


class STEMIntegration:
    """STEM ë„ê¹¨ë¹„ë“¤ê³¼ì˜ ì‹¤ì œ AI ëŒ€í™” ì‹œìŠ¤í…œ"""

    def __init__(self):
        self.system_name = "ğŸ° ë„ê¹¨ë¹„ë§ˆì„ì¥í„° ë°•ì‚¬ê¸‰ AI ìƒë‹´ì†Œ"

    def process_question(
        self, agent_type: str, question: str, user_ip: Optional[str] = None
    ) -> Dict[str, Any]:
        """ì‹¤ì œ AI ëŒ€í™” ëŠ¥ë ¥ìœ¼ë¡œ ì§ˆë¬¸ ì²˜ë¦¬"""
        try:
            from usage_tracker import usage_tracker

            # ì›ë˜ 16ê°œ ë„ê¹¨ë¹„ ì •ë³´
            agent_info = {
                "assistant": {
                    "emoji": "ğŸ¤–",
                    "name": "ë°•ì‚¬ê¸‰ ë¹„ì„œ ë„ê¹¨ë¹„",
                    "field": "ì—…ë¬´ ê´€ë¦¬",
                },
                "builder": {"emoji": "ğŸ’»", "name": "ë¹Œë” ë„ê¹¨ë¹„", "field": "ê°œë°œ"},
                "counselor": {"emoji": "ğŸ’¬", "name": "ìƒë‹´ ë„ê¹¨ë¹„", "field": "ìƒë‹´"},
                "creative": {"emoji": "ğŸ¨", "name": "ì°½ì‘ ë„ê¹¨ë¹„", "field": "ì°½ì‘"},
                "data_analyst": {
                    "emoji": "ğŸ“Š",
                    "name": "ë°ì´í„°ë¶„ì„ ë„ê¹¨ë¹„",
                    "field": "ë°ì´í„° ë¶„ì„",
                },
                "fortune": {"emoji": "ğŸ”®", "name": "ìš´ì„¸ ë„ê¹¨ë¹„", "field": "ìš´ì„¸"},
                "growth": {"emoji": "ğŸŒ±", "name": "ì„±ì¥ ë„ê¹¨ë¹„", "field": "ì„±ì¥"},
                "hr": {"emoji": "ğŸ‘¥", "name": "HR ë„ê¹¨ë¹„", "field": "ì¸ì‚¬ ê´€ë¦¬"},
                "marketing": {
                    "emoji": "ğŸ“¢",
                    "name": "ë§ˆì¼€íŒ… ë„ê¹¨ë¹„",
                    "field": "ë§ˆì¼€íŒ…",
                },
                "medical": {"emoji": "ğŸ¥", "name": "ì˜ë£Œ ë„ê¹¨ë¹„", "field": "ì˜ë£Œ"},
                "sales": {"emoji": "ğŸ’°", "name": "ì˜ì—… ë„ê¹¨ë¹„", "field": "ì˜ì—…"},
                "seo": {"emoji": "ğŸ”", "name": "SEO ë„ê¹¨ë¹„", "field": "ê²€ìƒ‰ ìµœì í™”"},
                "shopping": {"emoji": "ğŸ›’", "name": "ì‡¼í•‘ ë„ê¹¨ë¹„", "field": "ì‡¼í•‘"},
                "startup": {"emoji": "ğŸš€", "name": "ìŠ¤íƒ€íŠ¸ì—… ë„ê¹¨ë¹„", "field": "ì°½ì—…"},
                "village_chief": {
                    "emoji": "ğŸ‘‘",
                    "name": "ì´ì¥ ë„ê¹¨ë¹„",
                    "field": "ë§ˆì„ ê´€ë¦¬",
                },
                "writing": {
                    "emoji": "âœï¸",
                    "name": "ë°•ì‚¬ê¸‰ ë¬¸ì„œ ì‘ì„± ë„ê¹¨ë¹„",
                    "field": "ë¬¸ì„œ ì‘ì„±",
                },
            }

            if agent_type not in agent_info:
                # ì‹¤íŒ¨ ë¡œê·¸ ê¸°ë¡
                usage_tracker.log_usage(agent_type, question, False, user_ip)
                return {
                    "success": False,
                    "error": f"ì§€ì›í•˜ì§€ ì•ŠëŠ” ì—ì´ì „íŠ¸ íƒ€ì…: {agent_type}",
                }

            # ì§ˆë¬¸ ìœ íš¨ì„± ê²€ì‚¬
            if not question or len(question.strip()) < 2:
                usage_tracker.log_usage(agent_type, question, False, user_ip)
                return {
                    "success": False,
                    "error": "ì§ˆë¬¸ì´ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤. ìµœì†Œ 2ê¸€ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.",
                }

            # ë„ê¹¨ë¹„ë³„ ì „ë¬¸ ì‘ë‹µ ìƒì„±
            info = agent_info[agent_type]
            response = self._create_natural_ai_response(question, agent_type, info)

            # ì„±ê³µ ë¡œê·¸ ê¸°ë¡
            usage_tracker.log_usage(agent_type, question, True, user_ip)

            return {
                "success": True,
                "agent": {
                    "type": agent_type,
                    "name": info["name"],
                    "emoji": info["emoji"],
                    "field": info["field"],
                },
                "response": response,
                "timestamp": datetime.now().isoformat(),
            }

        except Exception as e:
            # ì—ëŸ¬ ë¡œê·¸ ê¸°ë¡
            usage_tracker.log_usage(agent_type, question, False, user_ip)
            return {"success": False, "error": f"ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}"}

    def _create_natural_ai_response(self, question: str, agent_type: str, info: dict) -> str:
        """ì‹¤ì œ AIì²˜ëŸ¼ ìì—°ìŠ¤ëŸ½ê³  ë§¥ë½ì ì¸ ì‘ë‹µ ìƒì„±"""
        
        # ë„ê¹¨ë¹„ë³„ ì „ë¬¸ ë¶„ì•¼ì™€ ì„±ê²© ì •ì˜
        agent_personalities = {
            "assistant": {
                "role": "íš¨ìœ¨ì ì´ê³  ì²´ê³„ì ì¸ ì—…ë¬´ ê´€ë¦¬ ì „ë¬¸ê°€",
                "style": "ì‹¤ìš©ì ì´ê³  êµ¬ì²´ì ì¸ ì¡°ì–¸",
                "expertise": ["ì‹œê°„ê´€ë¦¬", "ì—…ë¬´íš¨ìœ¨", "ìƒì‚°ì„±", "ê³„íšìˆ˜ë¦½", "ì¡°ì§ê´€ë¦¬"]
            },
            "builder": {
                "role": "ì°½ì˜ì ì´ê³  ì‹¤ìš©ì ì¸ ê°œë°œ ì „ë¬¸ê°€", 
                "style": "ê¸°ìˆ ì ì´ë©´ì„œë„ ì´í•´í•˜ê¸° ì‰¬ìš´ ì„¤ëª…",
                "expertise": ["í”„ë¡œê·¸ë˜ë°", "ì›¹ê°œë°œ", "ì•±ê°œë°œ", "ì‹œìŠ¤í…œì„¤ê³„", "ê¸°ìˆ ì•„í‚¤í…ì²˜"]
            },
            "counselor": {
                "role": "ë”°ëœ»í•˜ê³  ê³µê°ëŠ¥ë ¥ì´ ë›°ì–´ë‚œ ìƒë‹´ ì „ë¬¸ê°€",
                "style": "ê²½ì²­í•˜ê³  ê³µê°í•˜ë©° ë”°ëœ»í•œ ì¡°ì–¸",
                "expertise": ["ì‹¬ë¦¬ìƒë‹´", "ê°ˆë“±í•´ê²°", "ìŠ¤íŠ¸ë ˆìŠ¤ê´€ë¦¬", "ì¸ê°„ê´€ê³„", "ê°ì •ê´€ë¦¬"]
            },
            "creative": {
                "role": "ì˜ê°ì´ ë„˜ì¹˜ê³  ì°½ì˜ì ì¸ ì•„ì´ë””ì–´ ì „ë¬¸ê°€",
                "style": "ë…ì°½ì ì´ê³  í¥ë¯¸ë¡œìš´ ì•„ì´ë””ì–´ ì œì‹œ",
                "expertise": ["ì°½ì‘", "ë””ìì¸", "ë¸Œëœë”©", "ì½˜í…ì¸ ê¸°íš", "ì•„ì´ë””ì–´ë°œìƒ"]
            },
            "data_analyst": {
                "role": "ë…¼ë¦¬ì ì´ê³  ë¶„ì„ì ì¸ ë°ì´í„° ì „ë¬¸ê°€",
                "style": "ê·¼ê±°ì™€ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ í•œ ê°ê´€ì  ë¶„ì„",
                "expertise": ["ë°ì´í„°ë¶„ì„", "í†µê³„", "ì‹œê°í™”", "ì˜ˆì¸¡ëª¨ë¸ë§", "ë¹„ì¦ˆë‹ˆìŠ¤ì¸í…”ë¦¬ì „ìŠ¤"]
            },
            "fortune": {
                "role": "ì‹ ë¹„ë¡­ê³  ì§€í˜œë¡œìš´ ìš´ì„¸ ì „ë¬¸ê°€",
                "style": "ì‹ ë¹„ë¡œìš°ë©´ì„œë„ í¬ë§ì ì¸ ë©”ì‹œì§€",
                "expertise": ["ìš´ì„¸", "ì ì„±ìˆ ", "íƒ€ë¡œ", "í’ìˆ˜", "ìš´ëª…í•´ì„"]
            },
            "growth": {
                "role": "ë™ê¸°ë¶€ì—¬ê°€ ë„˜ì¹˜ëŠ” ì„±ì¥ ì „ë¬¸ê°€",
                "style": "ê²©ë ¤í•˜ê³  ë™ê¸°ë¶€ì—¬í•˜ëŠ” ê¸ì •ì  ì¡°ì–¸",
                "expertise": ["ìê¸°ê³„ë°œ", "ëª©í‘œì„¤ì •", "ìŠµê´€í˜•ì„±", "ë™ê¸°ë¶€ì—¬", "ì„±ì¥ì „ëµ"]
            },
            "hr": {
                "role": "ì‚¬ëŒ ì¤‘ì‹¬ì˜ ì¸ì‚¬ ê´€ë¦¬ ì „ë¬¸ê°€",
                "style": "ë°°ë ¤ ê¹Šê³  ê³µì •í•œ ì¸ì‚¬ ê´€ë¦¬ ì¡°ì–¸",
                "expertise": ["ì±„ìš©", "ì¸ì‚¬í‰ê°€", "ì¡°ì§ë¬¸í™”", "ë¦¬ë”ì‹­", "íŒ€ê´€ë¦¬"]
            },
            "marketing": {
                "role": "íŠ¸ë Œë“œì— ë¯¼ê°í•œ ë§ˆì¼€íŒ… ì „ë¬¸ê°€",
                "style": "ì°½ì˜ì ì´ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ ë§ˆì¼€íŒ… ì „ëµ",
                "expertise": ["ë¸Œëœë“œë§ˆì¼€íŒ…", "ë””ì§€í„¸ë§ˆì¼€íŒ…", "ê³ ê°ë¶„ì„", "ë§ˆì¼€íŒ…ì „ëµ", "ê´‘ê³ ê¸°íš"]
            },
            "medical": {
                "role": "ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ì˜ë£Œ ì •ë³´ ì „ë¬¸ê°€",
                "style": "ì •í™•í•˜ê³  ì‹ ì¤‘í•œ ì˜í•™ ì •ë³´ ì œê³µ",
                "expertise": ["ê±´ê°•ê´€ë¦¬", "ì§ˆë³‘ì˜ˆë°©", "ì˜í•™ì •ë³´", "ê±´ê°•ê²€ì§„", "ìƒí™œìŠµê´€"]
            },
            "sales": {
                "role": "ì—´ì •ì ì´ê³  ì„¤ë“ë ¥ ìˆëŠ” ì˜ì—… ì „ë¬¸ê°€",
                "style": "ì ê·¹ì ì´ê³  ì„±ê³¼ì§€í–¥ì ì¸ ì˜ì—… ì¡°ì–¸",
                "expertise": ["ì˜ì—…ì „ëµ", "ê³ ê°ê´€ê³„", "í˜‘ìƒê¸°ìˆ ", "ë§¤ì¶œê´€ë¦¬", "ì„¸ì¼ì¦ˆ"]
            },
            "seo": {
                "role": "ê²€ìƒ‰ì—”ì§„ì— ì •í†µí•œ SEO ì „ë¬¸ê°€",
                "style": "ê¸°ìˆ ì ì´ë©´ì„œë„ ì‹¤ë¬´ì ì¸ SEO ì¡°ì–¸",
                "expertise": ["ê²€ìƒ‰ìµœì í™”", "í‚¤ì›Œë“œë¶„ì„", "ì›¹ì‚¬ì´íŠ¸ìµœì í™”", "êµ¬ê¸€SEO", "ì½˜í…ì¸ SEO"]
            },
            "shopping": {
                "role": "í•©ë¦¬ì ì´ê³  íŠ¸ë Œë“œì— ë¯¼ê°í•œ ì‡¼í•‘ ì „ë¬¸ê°€",
                "style": "ì‹¤ìš©ì ì´ê³  ê²½ì œì ì¸ êµ¬ë§¤ ì¡°ì–¸",
                "expertise": ["ì œí’ˆë¹„êµ", "ê°€ê²©ë¶„ì„", "ì‡¼í•‘íŒ", "ì†Œë¹„íŒ¨í„´", "êµ¬ë§¤ê°€ì´ë“œ"]
            },
            "startup": {
                "role": "ë„ì „ì •ì‹ ì´ ê°•í•œ ì°½ì—… ì „ë¬¸ê°€",
                "style": "í˜„ì‹¤ì ì´ë©´ì„œë„ ê¿ˆì„ ì‘ì›í•˜ëŠ” ì°½ì—… ì¡°ì–¸",
                "expertise": ["ì°½ì—…ì „ëµ", "ë¹„ì¦ˆë‹ˆìŠ¤ëª¨ë¸", "íˆ¬ììœ ì¹˜", "ìŠ¤íƒ€íŠ¸ì—…ê²½ì˜", "ì‚¬ì—…ê³„íš"]
            },
            "village_chief": {
                "role": "ê²½í—˜ì´ í’ë¶€í•˜ê³  ì§€í˜œë¡œìš´ ë¦¬ë”",
                "style": "í¬ìš©ë ¥ ìˆê³  ê· í˜•ì¡íŒ ì¢…í•©ì  ì¡°ì–¸",
                "expertise": ["ë¦¬ë”ì‹­", "ì¡°ì§ê´€ë¦¬", "ê°ˆë“±ì¡°ì •", "ì˜ì‚¬ê²°ì •", "ì»¤ë®¤ë‹ˆí‹°ê´€ë¦¬"]
            },
            "writing": {
                "role": "ë¬¸ì¥ë ¥ì´ ë›°ì–´ë‚œ ê¸€ì“°ê¸° ì „ë¬¸ê°€",
                "style": "ëª…í™•í•˜ê³  í’ˆê²© ìˆëŠ” ë¬¸ì„œ ì‘ì„± ì¡°ì–¸",
                "expertise": ["ë¬¸ì„œì‘ì„±", "ê¸€ì“°ê¸°", "ë…¼ë¬¸ì‘ì„±", "ë³´ê³ ì„œ", "ì½˜í…ì¸ ë¼ì´íŒ…"]
            }
        }
        
        personality = agent_personalities.get(agent_type, {
            "role": "ì „ë¬¸ê°€",
            "style": "ë„ì›€ì´ ë˜ëŠ” ì¡°ì–¸",
            "expertise": ["ì „ë¬¸ìƒë‹´"]
        })
        
        # ì§ˆë¬¸ ë¶„ì„ ë° ë§¥ë½ì  ì‘ë‹µ ìƒì„±
        return self._generate_contextual_response(question, info, personality)

    def _generate_contextual_response(self, question: str, info: dict, personality: dict) -> str:
        """ë§¥ë½ì„ ê³ ë ¤í•œ ìì—°ìŠ¤ëŸ¬ìš´ ì‘ë‹µ ìƒì„±"""
        
        # ì§ˆë¬¸ ê¸¸ì´ì™€ ë³µì¡ë„ ë¶„ì„
        question_length = len(question)
        question_lower = question.lower()
        
        # ì¸ì‚¬ë§ ì²˜ë¦¬
        greetings = ["ì•ˆë…•", "í•˜ì´", "í—¬ë¡œ", "hi", "hello"]
        if any(greeting in question_lower for greeting in greetings) and question_length < 20:
            responses = [
                f"{info['emoji']} ì•ˆë…•í•˜ì„¸ìš”! {info['name']}ì…ë‹ˆë‹¤! ì–´ë–¤ {info['field']} ê´€ë ¨ ë„ì›€ì´ í•„ìš”í•˜ì‹ ê°€ìš”?",
                f"{info['emoji']} ë°˜ê°‘ìŠµë‹ˆë‹¤! {info['name']}ê°€ ì¸ì‚¬ë“œë ¤ìš”. {info['field']} ì „ë¬¸ê°€ë¡œì„œ ìµœì„ ì„ ë‹¤í•´ ë„ì™€ë“œë¦¬ê² ìŠµë‹ˆë‹¤!",
                f"{info['emoji']} ì•ˆë…•í•˜ì„¸ìš”! {info['field']} ì „ë¬¸ê°€ {info['name']}ì…ë‹ˆë‹¤. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?"
            ]
            return random.choice(responses)
        
        # ê°ì‚¬ í‘œí˜„ ì²˜ë¦¬
        thanks = ["ê³ ë§ˆì›Œ", "ê°ì‚¬", "ê³ ë§™", "thanks", "thank"]
        if any(thank in question_lower for thank in thanks):
            responses = [
                f"{info['emoji']} ë³„ë§ì”€ì„ìš”! {info['name']}ë¡œì„œ ë„ì›€ì´ ë˜ì—ˆë‹¤ë‹ˆ ì •ë§ ê¸°ì©ë‹ˆë‹¤!",
                f"{info['emoji']} ì²œë§Œì—ìš”! {info['field']} ê´€ë ¨í•´ì„œ ì–¸ì œë“  ì°¾ì•„ì£¼ì„¸ìš”!",
                f"{info['emoji']} ë„ì›€ì´ ë˜ì–´ì„œ ë‹¤í–‰ì´ì—ìš”! {info['name']}ëŠ” í•­ìƒ ì—¬ê¸° ìˆìŠµë‹ˆë‹¤!"
            ]
            return random.choice(responses)
        
        # ì „ë¬¸ ë¶„ì•¼ í‚¤ì›Œë“œê°€ í¬í•¨ëœ ê²½ìš°
        if any(expertise in question_lower for expertise in personality.get("expertise", [])):
            return self._generate_expert_response(question, info, personality)
        
        # ì¼ë°˜ì ì¸ ì§ˆë¬¸ì— ëŒ€í•œ ì „ë¬¸ê°€ì  ê´€ì  ì œì‹œ
        return self._generate_general_expert_response(question, info, personality)

    def _generate_expert_response(self, question: str, info: dict, personality: dict) -> str:
        """ì „ë¬¸ ë¶„ì•¼ ê´€ë ¨ ì‘ë‹µ ìƒì„±"""
        
        specific_solution = self._get_specific_solution(question, info['field'])
        
        return f"""{info['emoji']} {info['name']}ì…ë‹ˆë‹¤!

'{question}'ì— ëŒ€í•´ {personality['role']}ë¡œì„œ ë‹µë³€ë“œë¦¬ê² ìŠµë‹ˆë‹¤.

ğŸ¯ **ì „ë¬¸ê°€ ë¶„ì„:**
ì§ˆë¬¸í•˜ì‹  ë‚´ìš©ì€ ì œê°€ ê°€ì¥ ì˜ ë‹¤ë£° ìˆ˜ ìˆëŠ” {info['field']} ë¶„ì•¼ë„¤ìš”. {personality['style']}ë¥¼ ì œê³µí•´ë“œë¦¬ê² ìŠµë‹ˆë‹¤.

ğŸ’¡ **ë§ì¶¤ ì†”ë£¨ì…˜:**
{specific_solution}

âœ¨ **ì¶”ê°€ ì¡°ì–¸:**
ë” êµ¬ì²´ì ì¸ ìƒí™©ì´ë‚˜ ì„¸ë¶€ì‚¬í•­ì„ ì•Œë ¤ì£¼ì‹œë©´, ë”ìš± ì •í™•í•˜ê³  ì‹¤ìš©ì ì¸ ì¡°ì–¸ì„ ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤!

ğŸš€ **ë‹¤ìŒ ë‹¨ê³„:**
ê¶ê¸ˆí•œ ì ì´ ë” ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ë§ì”€í•´ì£¼ì„¸ìš”!"""

    def _generate_general_expert_response(self, question: str, info: dict, personality: dict) -> str:
        """ì¼ë°˜ì ì¸ ì§ˆë¬¸ì— ëŒ€í•œ ì „ë¬¸ê°€ ê´€ì  ì‘ë‹µ"""
        
        field_advice = self._get_field_specific_advice(question, info['field'])
        
        return f"""{info['emoji']} {info['name']}ì…ë‹ˆë‹¤!

'{question}'ì— ëŒ€í•´ {info['field']} ì „ë¬¸ê°€ ê´€ì ì—ì„œ ë‹µë³€ë“œë¦¬ê² ìŠµë‹ˆë‹¤.

ğŸ” **ì „ë¬¸ê°€ ì‹œê°:**
{personality['role']}ë¡œì„œ ì´ ë¬¸ì œë¥¼ ë°”ë¼ë³´ë©´, {info['field']} ê´€ì ì—ì„œ ì ‘ê·¼í•´ë³¼ ìˆ˜ ìˆì„ ê²ƒ ê°™ìŠµë‹ˆë‹¤.

ğŸ’­ **ì¢…í•©ì  ê³ ë ¤ì‚¬í•­:**
â€¢ í˜„ì¬ ìƒí™©ì˜ ì •í™•í•œ íŒŒì•…ì´ ì¤‘ìš”í•©ë‹ˆë‹¤
â€¢ {info['field']} ì›ì¹™ì„ ì ìš©í•œ ì²´ê³„ì  ì ‘ê·¼
â€¢ ì‹¤í–‰ ê°€ëŠ¥í•œ êµ¬ì²´ì  ë°©ì•ˆ ëª¨ìƒ‰

ğŸ¯ **ì œì•ˆì‚¬í•­:**
{field_advice}

ğŸ“ **ì¶”ê°€ ìƒë‹´:**
ë” ìì„¸í•œ ìƒí™©ì„ ì•Œë ¤ì£¼ì‹œë©´ {info['field']} ì „ë¬¸ì„±ì„ ë°”íƒ•ìœ¼ë¡œ ë” êµ¬ì²´ì ì¸ ë„ì›€ì„ ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤!"""

    def _get_specific_solution(self, question: str, field: str) -> str:
        """ë¶„ì•¼ë³„ êµ¬ì²´ì  ì†”ë£¨ì…˜ ì œê³µ"""
        
        solutions = {
            "ì—…ë¬´ ê´€ë¦¬": "íš¨ìœ¨ì ì¸ ì‹œê°„ ê´€ë¦¬ì™€ ìš°ì„ ìˆœìœ„ ì„¤ì •ì„ í†µí•´ ìƒì‚°ì„±ì„ ê·¹ëŒ€í™”í•˜ê³ , ì²´ê³„ì ì¸ ì—…ë¬´ í”„ë¡œì„¸ìŠ¤ë¥¼ êµ¬ì¶•í•˜ì„¸ìš”.",
            "ê°œë°œ": "ë¬¸ì œë¥¼ ë‹¨ê³„ë³„ë¡œ ë¶„í•´í•˜ê³ , ì ì ˆí•œ ê¸°ìˆ  ìŠ¤íƒì„ ì„ íƒí•˜ì—¬ í™•ì¥ ê°€ëŠ¥í•œ ì†”ë£¨ì…˜ì„ ì„¤ê³„í•´ë³´ì„¸ìš”.",
            "ìƒë‹´": "ë¨¼ì € ê°ì •ì„ ì¶©ë¶„íˆ ì¸ì •í•˜ê³  ìˆ˜ìš©í•œ í›„, ê±´ì„¤ì ì¸ í•´ê²° ë°©ì•ˆì„ í•¨ê»˜ ëª¨ìƒ‰í•´ë‚˜ê°€ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤.",
            "ì°½ì‘": "ê¸°ì¡´ì˜ í‹€ì—ì„œ ë²—ì–´ë‚˜ ìƒˆë¡œìš´ ê´€ì ìœ¼ë¡œ ì ‘ê·¼í•˜ê³ , ë‹¤ì–‘í•œ ì˜ê°ì˜ ì›ì²œì„ íƒìƒ‰í•´ë³´ì„¸ìš”.",
            "ë°ì´í„° ë¶„ì„": "ë°ì´í„°ì˜ í’ˆì§ˆì„ ë¨¼ì € ê²€ì¦í•˜ê³ , ì ì ˆí•œ ë¶„ì„ ë°©ë²•ë¡ ì„ ì ìš©í•˜ì—¬ ì˜ë¯¸ ìˆëŠ” ì¸ì‚¬ì´íŠ¸ë¥¼ ë„ì¶œí•˜ì„¸ìš”.",
            "ìš´ì„¸": "í˜„ì¬ì˜ ì—ë„ˆì§€ íë¦„ì„ ì´í•´í•˜ê³ , ê¸ì •ì ì¸ ë§ˆìŒê°€ì§ìœ¼ë¡œ ì¢‹ì€ ê¸°ìš´ì„ ëŒì–´ë‹¹ê¸°ì„¸ìš”.",
            "ì„±ì¥": "ì‘ì€ ìŠµê´€ë¶€í„° ì‹œì‘í•˜ì—¬ ê¾¸ì¤€íˆ ì‹¤ì²œí•˜ê³ , ë‹¨ê³„ì ìœ¼ë¡œ ëª©í‘œë¥¼ í™•ì¥í•´ë‚˜ê°€ì„¸ìš”.",
            "ì¸ì‚¬ ê´€ë¦¬": "êµ¬ì„±ì› ê°œê°œì¸ì˜ ê°•ì ì„ íŒŒì•…í•˜ê³ , ê³µì •í•˜ê³  íˆ¬ëª…í•œ ì‹œìŠ¤í…œì„ í†µí•´ ì¡°ì§ ì—­ëŸ‰ì„ ê·¹ëŒ€í™”í•˜ì„¸ìš”.",
            "ë§ˆì¼€íŒ…": "íƒ€ê²Ÿ ê³ ê°ì˜ ë‹ˆì¦ˆë¥¼ ì •í™•íˆ íŒŒì•…í•˜ê³ , ì°¨ë³„í™”ëœ ê°€ì¹˜ ì œì•ˆì„ í†µí•´ ë¸Œëœë“œ ê²½ìŸë ¥ì„ ê°•í™”í•˜ì„¸ìš”.",
            "ì˜ë£Œ": "ì •í™•í•œ ì§„ë‹¨ê³¼ ì „ë¬¸ì˜ ìƒë‹´ì„ ë°›ìœ¼ì‹œê³ , ì˜ˆë°© ì¤‘ì‹¬ì˜ ê±´ê°•í•œ ìƒí™œìŠµê´€ì„ ìœ ì§€í•˜ì„¸ìš”.",
            "ì˜ì—…": "ê³ ê°ì˜ ì…ì¥ì—ì„œ ìƒê°í•˜ê³ , ì§„ì •ì„± ìˆëŠ” ê´€ê³„ êµ¬ì¶•ì„ í†µí•´ ì‹ ë¢°ë¥¼ ë°”íƒ•ìœ¼ë¡œ í•œ ì˜ì—…ì„ í•˜ì„¸ìš”.",
            "ê²€ìƒ‰ ìµœì í™”": "ì‚¬ìš©ì ì˜ë„ì— ë§ëŠ” ê³ í’ˆì§ˆ ì½˜í…ì¸ ë¥¼ ì œì‘í•˜ê³ , ê¸°ìˆ ì  SEOë¥¼ ì²´ê³„ì ìœ¼ë¡œ ìµœì í™”í•˜ì„¸ìš”.",
            "ì‡¼í•‘": "ì‹ ì¤‘í•œ ë¹„êµê²€í† ë¥¼ í†µí•´ ê°€ì„±ë¹„ë¥¼ ë”°ì ¸ë³´ê³ , ì‹¤ì œ í•„ìš”ì„±ì„ ê³ ë ¤í•œ í•©ë¦¬ì  ì†Œë¹„ë¥¼ í•˜ì„¸ìš”.",
            "ì°½ì—…": "ì‹œì¥ ê²€ì¦ì„ í†µí•´ ì‹¤ì œ ê³ ê° ë¬¸ì œë¥¼ í•´ê²°í•˜ëŠ” ì†”ë£¨ì…˜ì„ ê°œë°œí•˜ê³ , ì ì§„ì ìœ¼ë¡œ ì‚¬ì—…ì„ í™•ì¥í•˜ì„¸ìš”.",
            "ë§ˆì„ ê´€ë¦¬": "ëª¨ë“  êµ¬ì„±ì›ì˜ ì˜ê²¬ì„ ë“£ê³  ì¡°ìœ¨í•˜ì—¬, ê³µë™ì²´ ì „ì²´ì˜ ì´ìµì„ ê³ ë ¤í•œ ê· í˜•ì¡íŒ ì˜ì‚¬ê²°ì •ì„ í•˜ì„¸ìš”.",
            "ë¬¸ì„œ ì‘ì„±": "ëª…í™•í•œ êµ¬ì¡°ì™€ ë…¼ë¦¬ì  íë¦„ì„ ê°–ì¶”ê³ , ë…ìì˜ ì…ì¥ì—ì„œ ì´í•´í•˜ê¸° ì‰½ê²Œ ì‘ì„±í•˜ì„¸ìš”."
        }
        
        return solutions.get(field, "ì „ë¬¸ì ì¸ ê´€ì ì—ì„œ ì²´ê³„ì ìœ¼ë¡œ ì ‘ê·¼í•˜ê³ , ì‹¤í–‰ ê°€ëŠ¥í•œ ë°©ì•ˆì„ ë‹¨ê³„ë³„ë¡œ ìˆ˜ë¦½í•´ë³´ì„¸ìš”.")

    def _get_field_specific_advice(self, question: str, field: str) -> str:
        """ë¶„ì•¼ë³„ ë§ì¶¤ ì¡°ì–¸ ì œê³µ"""
        
        advice = {
            "ì—…ë¬´ ê´€ë¦¬": "ì‹œê°„ ê´€ë¦¬ ë§¤íŠ¸ë¦­ìŠ¤ë¥¼ í™œìš©í•´ ì¤‘ìš”ë„ì™€ ê¸´ê¸‰ë„ë¥¼ ë¶„ë¥˜í•˜ê³ , ì§‘ì¤‘ ì‹œê°„ì„ í™•ë³´í•˜ì„¸ìš”.",
            "ê°œë°œ": "MVP(ìµœì†Œ ì‹¤í–‰ ì œí’ˆ)ë¶€í„° ì‹œì‘í•´ì„œ ì‚¬ìš©ì í”¼ë“œë°±ì„ ë°›ìœ¼ë©° ë°˜ë³µ ê°œì„ í•´ë‚˜ê°€ì„¸ìš”.",
            "ìƒë‹´": "ê²½ì²­ì˜ ìì„¸ë¡œ ìƒëŒ€ë°©ì˜ ë§ˆìŒì„ ì¶©ë¶„íˆ ì´í•´í•˜ê³ , í•¨ê»˜ í•´ê²°ì±…ì„ ì°¾ì•„ê°€ì„¸ìš”.",
            "ì°½ì‘": "ë‹¤ì–‘í•œ ê²½í—˜ê³¼ ê´€ì°°ì„ í†µí•´ ì˜ê°ì„ ì¶•ì í•˜ê³ , ì‹¤í—˜ì •ì‹ ì„ ê°–ê³  ë„ì „í•´ë³´ì„¸ìš”.",
            "ë°ì´í„° ë¶„ì„": "ê°€ì„¤ì„ ì„¸ìš°ê³  ë°ì´í„°ë¡œ ê²€ì¦í•˜ëŠ” ê³¼ì •ì„ ë°˜ë³µí•˜ì—¬ ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ê²°ê³¼ë¥¼ ë„ì¶œí•˜ì„¸ìš”.",
            "ìš´ì„¸": "í˜„ì¬ì— ì¶©ì‹¤í•˜ë©´ì„œë„ ë¯¸ë˜ì— ëŒ€í•œ ê¸ì •ì  ë¹„ì „ì„ ê°–ê³  í–‰ë™í•˜ì„¸ìš”.",
            "ì„±ì¥": "SMART ëª©í‘œ ì„¤ì •ë²•ì„ í™œìš©í•´ êµ¬ì²´ì ì´ê³  ì¸¡ì • ê°€ëŠ¥í•œ ëª©í‘œë¥¼ ìˆ˜ë¦½í•˜ì„¸ìš”.",
            "ì¸ì‚¬ ê´€ë¦¬": "ì •ê¸°ì ì¸ 1:1 ë©´ë‹´ê³¼ í”¼ë“œë°±ì„ í†µí•´ êµ¬ì„±ì›ê³¼ ì†Œí†µí•˜ê³  ì„±ì¥ì„ ì§€ì›í•˜ì„¸ìš”.",
            "ë§ˆì¼€íŒ…": "ê³ ê° ì—¬ì •ì„ ë¶„ì„í•˜ê³  ê° ë‹¨ê³„ë³„ ìµœì ì˜ í„°ì¹˜í¬ì¸íŠ¸ë¥¼ ì„¤ê³„í•˜ì„¸ìš”.",
            "ì˜ë£Œ": "ì •ê¸° ê±´ê°•ê²€ì§„ê³¼ í•¨ê»˜ ê· í˜•ì¡íŒ ì‹ë‹¨, ê·œì¹™ì ì¸ ìš´ë™ìœ¼ë¡œ ê±´ê°•ì„ ê´€ë¦¬í•˜ì„¸ìš”.",
            "ì˜ì—…": "ê³ ê°ì˜ ë‹ˆì¦ˆë¥¼ íŒŒì•…í•˜ê³  ê·¸ì— ë§ëŠ” ì†”ë£¨ì…˜ì„ ì œì‹œí•˜ëŠ” ì»¨ì„¤íŒ… ì˜ì—…ì„ í•˜ì„¸ìš”.",
            "ê²€ìƒ‰ ìµœì í™”": "í‚¤ì›Œë“œ ë¦¬ì„œì¹˜ë¶€í„° ì‹œì‘í•´ì„œ ì½˜í…ì¸  ìµœì í™”ì™€ ê¸°ìˆ ì  SEOë¥¼ ë³‘í–‰í•˜ì„¸ìš”.",
            "ì‡¼í•‘": "ê°€ê²© ë¹„êµ ì‚¬ì´íŠ¸ë¥¼ í™œìš©í•˜ê³ , ë¦¬ë·°ì™€ í‰ì ì„ ê¼¼ê¼¼íˆ í™•ì¸í•œ í›„ êµ¬ë§¤í•˜ì„¸ìš”.",
            "ì°½ì—…": "ë¦° ìŠ¤íƒ€íŠ¸ì—… ë°©ë²•ë¡ ì„ ì ìš©í•´ ë¹ ë¥¸ ì‹¤í—˜ê³¼ í•™ìŠµì„ í†µí•´ ì‚¬ì—… ëª¨ë¸ì„ ê²€ì¦í•˜ì„¸ìš”.",
            "ë§ˆì„ ê´€ë¦¬": "íˆ¬ëª…í•œ ì†Œí†µ ì±„ë„ì„ êµ¬ì¶•í•˜ê³ , ì •ê¸°ì ì¸ ì˜ê²¬ ìˆ˜ë ´ì„ í†µí•´ ë¯¼ì£¼ì ìœ¼ë¡œ ìš´ì˜í•˜ì„¸ìš”.",
            "ë¬¸ì„œ ì‘ì„±": "5W1H ì›ì¹™ì— ë”°ë¼ ì •ë³´ë¥¼ ì •ë¦¬í•˜ê³ , ë‹¨ë½ë³„ í•µì‹¬ ë©”ì‹œì§€ë¥¼ ëª…í™•íˆ í•˜ì„¸ìš”."
        }
        
        return advice.get(field, "ì „ë¬¸ ì§€ì‹ì„ ë°”íƒ•ìœ¼ë¡œ ë‹¨ê³„ì ì´ê³  ì‹¤ìš©ì ì¸ ì ‘ê·¼ ë°©ë²•ì„ ì°¾ì•„ë³´ì„¸ìš”.")

    def get_agent_info(self) -> Dict[str, Any]:
        """ë„ê¹¨ë¹„ ì •ë³´ ë°˜í™˜ (í”„ë¡ íŠ¸ì—”ë“œìš©)"""
        agent_info = {
            "assistant": {
                "emoji": "ğŸ¤–",
                "name": "ë°•ì‚¬ê¸‰ ë¹„ì„œ ë„ê¹¨ë¹„",
                "field": "ì—…ë¬´ ê´€ë¦¬",
            },
            "builder": {"emoji": "ğŸ’»", "name": "ë¹Œë” ë„ê¹¨ë¹„", "field": "ê°œë°œ"},
            "counselor": {"emoji": "ğŸ’¬", "name": "ìƒë‹´ ë„ê¹¨ë¹„", "field": "ìƒë‹´"},
            "creative": {"emoji": "ğŸ¨", "name": "ì°½ì‘ ë„ê¹¨ë¹„", "field": "ì°½ì‘"},
            "data_analyst": {
                "emoji": "ğŸ“Š",
                "name": "ë°ì´í„°ë¶„ì„ ë„ê¹¨ë¹„",
                "field": "ë°ì´í„° ë¶„ì„",
            },
            "fortune": {"emoji": "ğŸ”®", "name": "ìš´ì„¸ ë„ê¹¨ë¹„", "field": "ìš´ì„¸"},
            "growth": {"emoji": "ğŸŒ±", "name": "ì„±ì¥ ë„ê¹¨ë¹„", "field": "ì„±ì¥"},
            "hr": {"emoji": "ğŸ‘¥", "name": "HR ë„ê¹¨ë¹„", "field": "ì¸ì‚¬ ê´€ë¦¬"},
            "marketing": {
                "emoji": "ğŸ“¢",
                "name": "ë§ˆì¼€íŒ… ë„ê¹¨ë¹„",
                "field": "ë§ˆì¼€íŒ…",
            },
            "medical": {"emoji": "ğŸ¥", "name": "ì˜ë£Œ ë„ê¹¨ë¹„", "field": "ì˜ë£Œ"},
            "sales": {"emoji": "ğŸ’°", "name": "ì˜ì—… ë„ê¹¨ë¹„", "field": "ì˜ì—…"},
            "seo": {"emoji": "ğŸ”", "name": "SEO ë„ê¹¨ë¹„", "field": "ê²€ìƒ‰ ìµœì í™”"},
            "shopping": {"emoji": "ğŸ›’", "name": "ì‡¼í•‘ ë„ê¹¨ë¹„", "field": "ì‡¼í•‘"},
            "startup": {"emoji": "ğŸš€", "name": "ìŠ¤íƒ€íŠ¸ì—… ë„ê¹¨ë¹„", "field": "ì°½ì—…"},
            "village_chief": {
                "emoji": "ğŸ‘‘",
                "name": "ì´ì¥ ë„ê¹¨ë¹„",
                "field": "ë§ˆì„ ê´€ë¦¬",
            },
            "writing": {
                "emoji": "âœï¸",
                "name": "ë°•ì‚¬ê¸‰ ë¬¸ì„œ ì‘ì„± ë„ê¹¨ë¹„",
                "field": "ë¬¸ì„œ ì‘ì„±",
            },
        }

        return {
            "total_agents": len(agent_info),
            "agents": agent_info,
            "categories": {
                "ì—…ë¬´&ê´€ë¦¬": ["assistant", "hr", "village_chief", "growth"],
                "ì°½ì‘&ë§ˆì¼€íŒ…": ["creative", "marketing", "writing", "seo"],
                "ê¸°ìˆ &ë¶„ì„": ["builder", "data_analyst", "medical", "startup"],
                "ìƒí™œ&ìƒë‹´": ["counselor", "fortune", "sales", "shopping"],
            },
        }


# ì „ì—­ ì¸ìŠ¤í„´ìŠ¤
stem_ai = STEMIntegration()


def add_stem_routes(app):
    """FastAPI ì•±ì— STEM ë¼ìš°íŠ¸ ì¶”ê°€"""
    from fastapi import Request
    from fastapi.responses import HTMLResponse
    
    @app.post("/stem/chat")
    async def stem_chat(request: Request):
        """STEM ë„ê¹¨ë¹„ì™€ ì±„íŒ…"""
        try:
            data = await request.json()
            agent_type = data.get("agent_type")
            question = data.get("question")
            user_ip = request.client.host if request.client else "unknown"
            
            result = stem_ai.process_question(agent_type, question, user_ip)
            return result
        except Exception as e:
            return {"success": False, "error": f"ì„œë²„ ì˜¤ë¥˜: {str(e)}"}

    @app.get("/stem/info")
    async def stem_info():
        """STEM ë„ê¹¨ë¹„ ì •ë³´ ì¡°íšŒ"""
        return stem_ai.get_agent_info()

    @app.get("/stem/stats")
    async def stem_stats():
        """STEM ì‚¬ìš© í†µê³„ ì¡°íšŒ"""
        try:
            from usage_tracker import usage_tracker
            return usage_tracker.get_statistics()
        except Exception as e:
            return {"error": f"í†µê³„ ì¡°íšŒ ì‹¤íŒ¨: {str(e)}"}

    @app.get("/stem", response_class=HTMLResponse)
    async def stem_page():
        """STEM ë„ê¹¨ë¹„ ë©”ì¸ í˜ì´ì§€"""
        try:
            with open("index_stem.html", "r", encoding="utf-8") as f:
                return f.read()
        except FileNotFoundError:
            return "<h1>STEM í˜ì´ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h1>"
